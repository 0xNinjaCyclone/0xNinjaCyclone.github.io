<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv='cache-control' content='no-cache'> 
    <meta http-equiv='expires' content='0'> 
    <meta http-equiv='pragma' content='no-cache'>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content=""
    />
    
      
        <title>[Exploit development] 6- Dealing with ELF files programmatically | 0xNinjaCyclone Blog</title>
      
    
    <link rel="stylesheet" href="/css/reset.css"/>
    <link rel="stylesheet" href="/css/font.css"/>
    <link rel="stylesheet" href="/css/smigle2.css"/>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/fav-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/fav-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="safary-1120x1120.png" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
  </head>
  
  <body>
    <div id="root">
      <header>
  <div id="brand">
    <a class="icon-link" href="https://0xninjacyclone.github.io/">
      <img
        class="icon"
        src="/images/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://0xninjacyclone.github.io/"><h1>0xNinjaCyclone Blog</h1></a>
      <h3>Penetration tester and Red teamer</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
    
  </nav>
  <hr />
</header>

      <div id="content">
        
  <main>
    <article>
      <h1 class="title">[Exploit development] 6- Dealing with ELF files programmatically</h1>
      
      <div class="post-meta">
  <strong>
    <span>Posted on</span>
    <time>2024-01-05</time>
    <span>in</span>
    
      <a href="/categories/exploitdev">exploitdev</a>
  </strong>
  <span> • 4294 words</span>
  <span> • 21 minute read</span>
  
  
    <div>
      <span>Tags:</span>
      
        <a href="/tags/exploit-development">exploit-development</a>, 
        <a href="/tags/binary-exploitation">binary-exploitation</a>, 
        <a href="/tags/vulnerability-research">vulnerability-research</a>, 
        <a href="/tags/binary-file">binary-file</a>, 
        <a href="/tags/pe">pe</a>
    </div>
  
</div>

      <div class="content"><h2 id="intro">Intro</h2>
<p>Welcome to our third part in the exploration of executable binary files. This article delves into the structure of ELF files, exploring the critical information they contain and how to programmatically interact with them. As previously mentioned, while the PE format is vital for cybersecurity specialists, especially the specializations emerging from reverse engineering, our focus here is on comprehending the ELF format which is also important. First, you had better read <a href="https://0xninjacyclone.github.io/posts/exploitdev_4_binfiles/">the first part</a>, which is an important theoretical overview of executable binary files, then read <a href="https://0xninjacyclone.github.io/posts/exploitdev_5_winpe/">the second part</a>, which offers a practical in-depth exploration of Windows PE files, and a lot of base concepts we&rsquo;re gonna use have been explained in that part.</p>
<h2 id="prepare-elf-parser">Prepare ELF parser</h2>
<p>Now, it&rsquo;s time to begin crafting our ELF file parser. First, we implement the main function that takes the ELF file name via command line arguments.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pBuffer;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> nRet <span style="color:#f92672">=</span> EXIT_FAILURE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( argc <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Usage:</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">./ELFParser &lt;/path/to/elffile&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">ReadELFFile</span>(argv[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span> pBuffer )
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Failed to read %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> LEAVE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		PARSE HERE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	nRet <span style="color:#f92672">=</span> EXIT_SUCCESS;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LEAVE:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> ( pBuffer ) <span style="color:#a6e22e">free</span>(pBuffer);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> nRet;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The main function reads the ELF file by using the <code>ReadELFFile</code> function, which is implemented as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ReadELFFile</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cpFileName)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    FILE <span style="color:#f92672">*</span>pFile;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pBuffer;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> lSize;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Get a file handle
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ( pFile <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(cpFileName, <span style="color:#e6db74">&#34;rb&#34;</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Tell the handle about the ending of the file to obtain its size 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">fseek</span>(pFile, <span style="color:#ae81ff">0L</span>, SEEK_END);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Get the file size
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        lSize <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftell</span>(pFile);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Restore back the handle
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">fseek</span>(pFile, <span style="color:#ae81ff">0L</span>, SEEK_SET);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Allocate some memory for the buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>(pBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(lSize)) ) <span style="color:#75715e">// OOM CASE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">goto</span> LEAVE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Read the file content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">fread</span>(pBuffer, lSize, <span style="color:#ae81ff">1L</span>, pFile);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LEAVE:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( pFile ) <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pBuffer;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="headers">Headers</h2>
<h3 id="elf-header-ehdr">ELF header (Ehdr)</h3>
<p>The ELF file&rsquo;s header is described by either the <code>Elf32_Ehdr</code> or <code>Elf64_Ehdr</code> data type, depending on the architecture:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#define EI_NIDENT 16
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> e_ident[EI_NIDENT];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span>      e_type;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span>      e_machine;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>      e_version;
</span></span><span style="display:flex;"><span>    ElfN_Addr     e_entry;
</span></span><span style="display:flex;"><span>    ElfN_Off      e_phoff;
</span></span><span style="display:flex;"><span>    ElfN_Off      e_shoff;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>      e_flags;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span>      e_ehsize;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span>      e_phentsize;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span>      e_phnum;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span>      e_shentsize;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span>      e_shnum;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span>      e_shstrndx;
</span></span><span style="display:flex;"><span>} ElfN_Ehdr;
</span></span></code></pre></div><ul>
<li><strong>e_ident</strong>: This array of bytes specifies how to interpret the file, independent of the processor or the file&rsquo;s remaining contents. First four bytes are the image magic number (0x7fELF).</li>
<li><strong>e_type</strong>: This member identifies the object file type:
<ol>
<li><code>ET_NONE</code>: An unknown type.</li>
<li><code>ET_REL</code>: A relocatable file.</li>
<li><code>ET_EXEC</code>: An executable file.</li>
<li><code>ET_DYN</code>: A shared object.</li>
<li><code>ET_CORE</code>: A core file.</li>
</ol>
</li>
<li><strong>e_machine</strong>: This member specifies the required architecture for an individual file.</li>
<li><strong>e_entry</strong>: This member gives the virtual address to which the system first transfers control, thus starting the process. If the file has no associated entry point, this member holds zero.</li>
<li><strong>e_phoff</strong>: This member holds the program header table&rsquo;s file offset in bytes. If the file has no program header table, this member holds zero.</li>
<li><strong>e_shoff</strong>: This member holds the section header table&rsquo;s file offset in bytes. If the file has no section header table, this member holds zero.</li>
<li><strong>e_ehsize</strong>: This member holds the ELF header&rsquo;s size in bytes.</li>
<li><strong>e_phentsize</strong>: This member holds the size in bytes of one entry in the file&rsquo;s program header table; all entries are the same size.</li>
<li><strong>e_phnum</strong>: This member holds the number of entries in the program header table. Thus the product of <code>e_phentsize</code> and <code>e_phnum</code> gives the table&rsquo;s size in bytes.  If a file has no program header, <code>e_phnum</code> holds the value zero.</li>
<li><strong>e_shentsize</strong>: This member holds a sections header&rsquo;s size in bytes. A section header is one entry in the section header table; all entries are the same size.</li>
<li><strong>e_shnum</strong>: This member holds the number of entries in the section header table. Thus the product of <code>e_shentsize</code> and <code>e_shnum</code> gives the section header table&rsquo;s size in bytes. If a file has no section header table, <code>e_shnum</code> holds the value of zero.</li>
<li><strong>e_shstrndx</strong>: This member holds the section header table index of the entry associated with the section name string table. If the file has no section name string table, this member holds the value <code>SHN_UNDEF</code>.</li>
</ul>
<h3 id="program-header-phdr">Program header (Phdr)</h3>
<p>An array of structures, each describing a segment or other information the system needs to prepare the program for execution. An object file segment contains one or more sections. Program headers are meaningful only for executable and shared object files. A file specifies its own program header size with
the ELF header&rsquo;s <code>e_phentsize</code> and <code>e_phnum members</code>. The ELF program header is described by the type <code>Elf32_Phdr</code> or <code>Elf64_Phdr</code> depending on the architecture:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   p_type;
</span></span><span style="display:flex;"><span>    Elf32_Off  p_offset;
</span></span><span style="display:flex;"><span>    Elf32_Addr p_vaddr;
</span></span><span style="display:flex;"><span>    Elf32_Addr p_paddr;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   p_filesz;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   p_memsz;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   p_flags;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   p_align;
</span></span><span style="display:flex;"><span>} Elf32_Phdr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   p_type;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   p_flags;
</span></span><span style="display:flex;"><span>    Elf64_Off  p_offset;
</span></span><span style="display:flex;"><span>    Elf64_Addr p_vaddr;
</span></span><span style="display:flex;"><span>    Elf64_Addr p_paddr;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span>   p_filesz;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span>   p_memsz;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span>   p_align;
</span></span><span style="display:flex;"><span>} Elf64_Phdr;
</span></span></code></pre></div><ul>
<li><strong>p_type</strong>: This member of the structure indicates what kind of segment this array element describes or how to interpret the array element&rsquo;s information. This member can be one of the following values:
<ol>
<li><code>PT_NULL</code>: The array element is unused and the other members&rsquo; values are undefined.</li>
<li><code>PT_LOAD</code>: The array element specifies a loadable segment, described by <code>p_filesz</code> and <code>p_memsz</code>.  The bytes from the file are mapped to the beginning of the memory segment.  If the segment&rsquo;s memory size <code>p_memsz</code> is larger than the file size <code>p_filesz</code>, the &ldquo;extra&rdquo; bytes are defined to hold the value 0 and to follow the segment&rsquo;s initialized area. The file size may not be larger than the memory size. Loadable segment entries in the program header table appear in ascending order, sorted on the <code>p_vaddr</code> member.</li>
<li><code>PT_INTERP</code>: The array element specifies the location and size of a null-terminated pathname to invoke as an interpreter.</li>
<li><code>PT_NOTE</code>: The array element specifies the location of notes <code>ElfN_Nhdr</code>.</li>
<li><code>PT_SHLIB</code>: This segment type is reserved but has unspecified semantics.</li>
<li><code>PT_PHDR</code>: The array element, if present, specifies the location and size of the program header table itself, both in the file and in the memory image of the program.</li>
<li><code>PT_LOPROC | PT_HIPROC</code>: Reserved for processor-specific semantics.</li>
<li><code>PT_GNU_STACK</code>: GNU extension which is used by the Linux kernel to control the state of the stack via the flags set in the p_flags member.</li>
</ol>
</li>
<li><strong>p_offset</strong>: This member holds the offset from the beginning of the file at which the first byte of the segment resides.</li>
<li><strong>p_vaddr</strong>: On systems for which physical addressing is relevant, this member is reserved for the segment&rsquo;s physical address. Under BSD this member is not used and must be zero.</li>
<li><strong>p_paddr</strong>: On systems for which physical addressing is relevant, this member is reserved for the segment&rsquo;s physical address. Under BSD this member is not used and must be zero.</li>
<li><strong>p_filesz</strong>: This member holds the number of bytes in the file image of the segment. It may be zero.</li>
<li><strong>p_memsz</strong>: This member holds the number of bytes in the memory image of the segment. It may be zero.</li>
</ul>
<h3 id="section-header-shdr">Section header (Shdr)</h3>
<p>An array of <code>Elf32_Shdr</code> or <code>Elf64_Shdr</code> structures. The <code>ElfN_Ehdr.e_shoff</code> member gives the byte offset from the beginning of the file to the section header table. <code>ElfN_Ehdr.e_shnum</code> holds the number of entries the section header table contains. <code>ElfN_Ehdr.e_shentsize</code> holds the size in bytes of each entry.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   sh_name;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   sh_type;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   sh_flags;
</span></span><span style="display:flex;"><span>    Elf32_Addr sh_addr;
</span></span><span style="display:flex;"><span>    Elf32_Off  sh_offset;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   sh_size;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   sh_link;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   sh_info;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   sh_addralign;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   sh_entsize;
</span></span><span style="display:flex;"><span>} Elf32_Shdr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   sh_name;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   sh_type;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span>   sh_flags;
</span></span><span style="display:flex;"><span>    Elf64_Addr sh_addr;
</span></span><span style="display:flex;"><span>    Elf64_Off  sh_offset;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span>   sh_size;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   sh_link;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   sh_info;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span>   sh_addralign;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span>   sh_entsize;
</span></span><span style="display:flex;"><span>} Elf64_Shdr;
</span></span></code></pre></div><ul>
<li><strong>sh_name</strong>: An index into the section header string table section, giving the location of a null-terminated section&rsquo;s name.</li>
<li><strong>sh_type</strong>: This member categorizes the section&rsquo;s contents and semantics.</li>
<li><strong>sh_flags</strong>: Some flags describe miscellaneous attributes. such as, is the section writable? occupies memory during process execution?</li>
<li><strong>sh_addr</strong>: This member holds the address at which the section&rsquo;s first byte should reside, or zero if doesn&rsquo;t appear in the memory image of a process.</li>
<li><strong>sh_offset</strong>: This member&rsquo;s value holds the byte offset from the beginning of the file to the first byte in the section.</li>
<li><strong>sh_size</strong>: The section&rsquo;s size in bytes.</li>
<li><strong>sh_link</strong>: This member holds a section header table index link, whose interpretation depends on the section type.</li>
<li><strong>sh_entsize</strong>: The size in bytes of fixed-sized entries, or zero if the section does not hold a table of fixed-size entries.</li>
</ul>
<h3 id="parse-headers">Parse headers</h3>
<p>Let&rsquo;s develop a function that parses this valuable data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ParseHeaders</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pBaseAddress)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Elf64_Addr elfPtr;
</span></span><span style="display:flex;"><span>    Elf64_Addr elfSectionPtr;
</span></span><span style="display:flex;"><span>    Elf64_Half nEntries;
</span></span><span style="display:flex;"><span>    Elf64_Word wPadding;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PRINT_LINE</span>(<span style="color:#e6db74">&#34;ELF HEADER&#34;</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Pointing now to the beginning of the file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Image magic number          =&gt; %X (%.4s)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">*</span>(<span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*</span>) elfPtr, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) elfPtr);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Arch                        =&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ( ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_ident[EI_CLASS] )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> ELFCLASS64:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;x64&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> ELFCLASS32:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;x32&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Invalid&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ELF type                    =&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ( ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_type )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> ET_REL:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Relocatable&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> ET_EXEC:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Executable&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> ET_DYN:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;DYN (Position-Independent Executable file)&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> ET_NONE:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Unknown&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Machine                     =&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ( ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_machine )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> EM_386:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Intel x86&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> EM_IA_64:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Intel Itanium&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> EM_X86_64:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;AMD x86-64&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> EM_NONE:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Unknown&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Entry point                 =&gt; 0x%X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_entry);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ELF header size             =&gt; %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_ehsize);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Program header offset       =&gt; 0x%X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_phoff);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Program header Entry size   =&gt; %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_phentsize);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Numbre of entries           =&gt; %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_phnum);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Section header offset       =&gt; 0x%X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_shoff);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Section header size         =&gt; %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_shentsize);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Numbre of entries           =&gt; %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_shnum);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Section name table offset   =&gt; 0x%X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_shstrndx);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//**************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">PRINT_LINE</span>(<span style="color:#e6db74">&#34;Program Header&#34;</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Number of entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    nEntries <span style="color:#f92672">=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_phnum;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Pointing now to Program Header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfPtr <span style="color:#f92672">+=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_phoff;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Type</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Offset</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">VirtAddr</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">PhysAddr</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">FileSize</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">MemSize</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Flag&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> ( nEntries<span style="color:#f92672">--</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_type <span style="color:#f92672">!=</span> PT_NULL )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">switch</span> ( ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_type )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_LOAD:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;LOAD</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_DYNAMIC:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;DYNAMIC</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_INTERP:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;INTERP</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_NOTE:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;NOTE</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_SHLIB:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;SHLIB</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_PHDR:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;PHDR</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_GNU_STACK:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;GNU_STACK&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_LOPROC:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;LOPROC</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_HIPROC:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;HIPROC</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Unknown</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%d</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">%d</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_offset,
</span></span><span style="display:flex;"><span>                ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_vaddr,
</span></span><span style="display:flex;"><span>                ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_paddr,
</span></span><span style="display:flex;"><span>                ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_filesz,
</span></span><span style="display:flex;"><span>                ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_memsz
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_flags <span style="color:#f92672">&amp;</span> PF_X )
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;EXECUTABLE &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_flags <span style="color:#f92672">&amp;</span> PF_W )
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;WRITABLE &#34;</span>);
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_flags <span style="color:#f92672">&amp;</span> PF_R )
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;READABLE &#34;</span>);
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// New Line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Next entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        elfPtr <span style="color:#f92672">+=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_phentsize;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//**************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">PRINT_LINE</span>(<span style="color:#e6db74">&#34;Section Header&#34;</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Move to section header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shoff;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Section name string header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfSectionPtr <span style="color:#f92672">=</span> elfPtr <span style="color:#f92672">+</span> ( ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shstrndx <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(Elf64_Shdr) );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Jump on the names table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfSectionPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfSectionPtr)<span style="color:#f92672">-&gt;</span>sh_offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Number of entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    nEntries <span style="color:#f92672">=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shnum;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Offset</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Addr</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Size</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Type</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Name</span><span style="color:#ae81ff">\t\t\t</span><span style="color:#e6db74">Flags&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> ( nEntries<span style="color:#f92672">--</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_type <span style="color:#f92672">!=</span> SHT_NOBITS <span style="color:#f92672">&amp;&amp;</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_size )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;0x%LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%d</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">0x%08LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%s&#34;</span>,
</span></span><span style="display:flex;"><span>                ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_offset,
</span></span><span style="display:flex;"><span>                ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_addr,
</span></span><span style="display:flex;"><span>                ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_size,
</span></span><span style="display:flex;"><span>                ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_type,
</span></span><span style="display:flex;"><span>                (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) elfSectionPtr <span style="color:#f92672">+</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_name 
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Alignment
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            wPadding <span style="color:#f92672">=</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">strlen</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) elfSectionPtr <span style="color:#f92672">+</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_name);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> ( wPadding<span style="color:#f92672">--</span> ) <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Handle flags
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> ( ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_flags <span style="color:#f92672">&amp;</span> SHF_WRITE )
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;WRITABLE &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_flags <span style="color:#f92672">&amp;</span> SHF_ALLOC )
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ALLOCATABLE &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_flags <span style="color:#f92672">&amp;</span> SHF_EXECINSTR )
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;EXECUTABLE &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// New Line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Next section
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        elfPtr <span style="color:#f92672">+=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shentsize;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="string-and-symbol-tables-imports--exports">String and symbol tables (Imports &amp; Exports)</h2>
<p>In contrast to the Windows PE format, ELF files consolidate imports and exports within a single structure. Each section contains an array of <strong>Symbol table</strong>, each item of that array contains the index of its corresponding name in <strong>String table</strong>.</p>
<h3 id="string-table-sections">String table sections</h3>
<p>An array of null-terminated strings that contains symbol and section names.</p>
<h3 id="symbol-table">Symbol table</h3>
<p>symbol table holds information needed to locate and relocate a program&rsquo;s symbolic definitions and references. A symbol table index is a subscript into this array.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>      st_name;
</span></span><span style="display:flex;"><span>    Elf32_Addr    st_value;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>      st_size;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> st_info;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> st_other;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span>      st_shndx;
</span></span><span style="display:flex;"><span>} Elf32_Sym;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>      st_name;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> st_info;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> st_other;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span>      st_shndx;
</span></span><span style="display:flex;"><span>    Elf64_Addr    st_value;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span>      st_size;
</span></span><span style="display:flex;"><span>} Elf64_Sym;
</span></span></code></pre></div><p><strong>st_name</strong>: An index into the object file&rsquo;s symbol string table, if the value is zero, the symbol has no name.
<strong>st_info</strong>: This member specifies the symbol&rsquo;s type and binding attributes
<strong>st_other</strong>: This member defines the symbol visibility.
<strong>st_shndx</strong>: An index into the relevant section header table index.
<strong>st_value</strong>: This member gives the value of the associated symbol.
<strong>st_size</strong>: For clarification, <strong>st_size</strong> represents the size of symbols, with a value of zero indicating either no size or an unknown size.</p>
<h3 id="parse-symbols">Parse Symbols</h3>
<p>Let&rsquo;s develop a function that parses those sections and obtains their valuable data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ParseSymbols</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pBaseAddress)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Elf64_Addr elfPtr;
</span></span><span style="display:flex;"><span>    Elf64_Addr elfSectionHdrPtr;
</span></span><span style="display:flex;"><span>    Elf64_Addr elfSymPtr;
</span></span><span style="display:flex;"><span>    Elf64_Addr elfStrSectionPtr;
</span></span><span style="display:flex;"><span>    Elf64_Half nEntries;
</span></span><span style="display:flex;"><span>    Elf64_Word wSymbols;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PRINT_LINE</span>(<span style="color:#e6db74">&#34;Symbols&#34;</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Pointing now to the section header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfSectionHdrPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shoff;
</span></span><span style="display:flex;"><span>    elfPtr <span style="color:#f92672">=</span> elfSectionHdrPtr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Number of section entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    nEntries <span style="color:#f92672">=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shnum;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Value</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Type</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Bind</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Size</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Name&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Iterate over all section entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> ( nEntries<span style="color:#f92672">--</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Find symbols
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>            ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_type <span style="color:#f92672">==</span> SHT_SYMTAB <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>            ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_type <span style="color:#f92672">==</span> SHT_DYNSYM
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Jump on the symbols section
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            elfSymPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Find string section header table 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            elfStrSectionPtr <span style="color:#f92672">=</span> elfSectionHdrPtr <span style="color:#f92672">+</span> ( <span style="color:#66d9ef">sizeof</span>(Elf64_Shdr) <span style="color:#f92672">*</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_link );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Jump on the string table ( .strtab )
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            elfStrSectionPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfStrSectionPtr)<span style="color:#f92672">-&gt;</span>sh_offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Calculate the number of symbols
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            wSymbols <span style="color:#f92672">=</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_size <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(Elf64_Sym);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Iterate over all symbol entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> ( wSymbols<span style="color:#f92672">--</span> )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> ( ((Elf64_Sym <span style="color:#f92672">*</span>) elfSymPtr)<span style="color:#f92672">-&gt;</span>st_size )
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;0x%08LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%02X</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%02X</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%d</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                        ((Elf64_Sym <span style="color:#f92672">*</span>) elfSymPtr)<span style="color:#f92672">-&gt;</span>st_value,
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">ELF64_ST_TYPE</span>( ((Elf64_Sym <span style="color:#f92672">*</span>) elfSymPtr)<span style="color:#f92672">-&gt;</span>st_info ),
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">ELF64_ST_BIND</span>( ((Elf64_Sym <span style="color:#f92672">*</span>) elfSymPtr)<span style="color:#f92672">-&gt;</span>st_info ),
</span></span><span style="display:flex;"><span>                        ((Elf64_Sym <span style="color:#f92672">*</span>) elfSymPtr)<span style="color:#f92672">-&gt;</span>st_size,
</span></span><span style="display:flex;"><span>                        (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) elfStrSectionPtr <span style="color:#f92672">+</span> ((Elf64_Sym <span style="color:#f92672">*</span>) elfSymPtr)<span style="color:#f92672">-&gt;</span>st_name
</span></span><span style="display:flex;"><span>                    );
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Next symbol entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                elfSymPtr <span style="color:#f92672">+=</span> <span style="color:#66d9ef">sizeof</span>(Elf64_Sym);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Next section entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        elfPtr <span style="color:#f92672">+=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shentsize;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="relocations">Relocations</h2>
<p>Relocation is the process of connecting symbolic references with symbolic definitions. Relocatable files must have information that describes how to modify their section contents, thus allowing executable and shared object files to hold the right information for a process&rsquo;s program image.</p>
<h3 id="relocation-table">Relocation table</h3>
<p>One of the following structures are found within each of the relocation sections, depending on the architecture:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// do not need an addend
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    Elf32_Addr r_offset;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   r_info;
</span></span><span style="display:flex;"><span>} Elf32_Rel;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    Elf64_Addr r_offset;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span>   r_info;
</span></span><span style="display:flex;"><span>} Elf64_Rel;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// need an addend
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    Elf32_Addr r_offset;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span>   r_info;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int32_t</span>    r_addend;
</span></span><span style="display:flex;"><span>} Elf32_Rela;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    Elf64_Addr r_offset;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span>   r_info;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int64_t</span>    r_addend;
</span></span><span style="display:flex;"><span>} Elf64_Rela;
</span></span></code></pre></div><ul>
<li><strong>r_offset</strong>: The location at which to apply the relocation action. For a relocatable file, the value is the byte offset from the beginning of the section to the storage unit affected by the relocation. For an executable file or shared object, the value is the virtual address of the storage unit affected by the relocation.</li>
<li><strong>r_info</strong>: This member gives both the symbol table index with respect to which the relocation must be made and the type of relocation to apply.</li>
<li><strong>r_addend</strong>: a constant addend used to compute the value to be stored into the relocatable field.</li>
</ul>
<h3 id="parse-relocations">Parse relocations</h3>
<p>Let&rsquo;s develop a function that parses rela section and obtains its data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ParseRelocations</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pBaseAddress)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Elf64_Addr elfPtr;
</span></span><span style="display:flex;"><span>    Elf64_Addr elfRelocPtr;
</span></span><span style="display:flex;"><span>    Elf64_Half nEntries;
</span></span><span style="display:flex;"><span>    Elf64_Word wRelocEntries;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PRINT_LINE</span>(<span style="color:#e6db74">&#34;Relocations&#34;</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Pointing now to the section header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shoff;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Number of sections
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    nEntries <span style="color:#f92672">=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shnum;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Offset</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Addend</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Type</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Symtab index&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Iterate over all sections
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> ( nEntries<span style="color:#f92672">--</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Find relocation section header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ( ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_type <span style="color:#f92672">==</span> SHT_RELA )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Find relocations entries of current section
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            elfRelocPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Number of relocation entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            wRelocEntries <span style="color:#f92672">=</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_size <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(Elf64_Rela);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Iterate over all relocation entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> ( wRelocEntries<span style="color:#f92672">--</span> )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;0x%08X</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08X</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08X</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                    ((Elf64_Rela <span style="color:#f92672">*</span>) elfRelocPtr)<span style="color:#f92672">-&gt;</span>r_offset,
</span></span><span style="display:flex;"><span>                    ((Elf64_Rela <span style="color:#f92672">*</span>) elfRelocPtr)<span style="color:#f92672">-&gt;</span>r_addend,
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">ELF64_R_TYPE</span>( ((Elf64_Rela <span style="color:#f92672">*</span>) elfRelocPtr)<span style="color:#f92672">-&gt;</span>r_info ),
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">ELF64_R_SYM</span>( ((Elf64_Rela <span style="color:#f92672">*</span>) elfRelocPtr)<span style="color:#f92672">-&gt;</span>r_info )
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Next reloc entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                elfRelocPtr <span style="color:#f92672">+=</span> <span style="color:#66d9ef">sizeof</span>(Elf64_Rela);
</span></span><span style="display:flex;"><span>            } 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Next section entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        elfPtr <span style="color:#f92672">+=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shentsize;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="the-full-code">The full code</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdbool.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;elf.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PRINT_LINE(str, n) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	printf(&#34;\n------%s&#34;, str); \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	for (uint16_t i = 0; i &lt; n - strlen(str); i++) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		printf(&#34;-&#34;); \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	puts(&#34;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ParseHeaders</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pBaseAddress)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Elf64_Addr elfPtr;
</span></span><span style="display:flex;"><span>    Elf64_Addr elfSectionPtr;
</span></span><span style="display:flex;"><span>    Elf64_Half nEntries;
</span></span><span style="display:flex;"><span>    Elf64_Word wPadding;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PRINT_LINE</span>(<span style="color:#e6db74">&#34;ELF HEADER&#34;</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Pointing now to the beginning of the file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Image magic number          =&gt; %X (%.4s)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">*</span>(<span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*</span>) elfPtr, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) elfPtr);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Arch                        =&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ( ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_ident[EI_CLASS] )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> ELFCLASS64:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;x64&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> ELFCLASS32:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;x32&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Invalid&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ELF type                    =&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ( ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_type )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> ET_REL:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Relocatable&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> ET_EXEC:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Executable&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> ET_DYN:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;DYN (Position-Independent Executable file)&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> ET_NONE:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Unknown&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Machine                     =&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ( ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_machine )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> EM_386:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Intel x86&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> EM_IA_64:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Intel Itanium&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> EM_X86_64:
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;AMD x86-64&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> EM_NONE:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Unknown&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Entry point                 =&gt; 0x%X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_entry);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ELF header size             =&gt; %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_ehsize);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Program header offset       =&gt; 0x%X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_phoff);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Program header Entry size   =&gt; %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_phentsize);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Numbre of entries           =&gt; %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_phnum);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Section header offset       =&gt; 0x%X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_shoff);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Section header size         =&gt; %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_shentsize);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Numbre of entries           =&gt; %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_shnum);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Section name table offset   =&gt; 0x%X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_shstrndx);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//**************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">PRINT_LINE</span>(<span style="color:#e6db74">&#34;Program Header&#34;</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Number of entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    nEntries <span style="color:#f92672">=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_phnum;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Pointing now to Program Header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfPtr <span style="color:#f92672">+=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>e_phoff;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Type</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Offset</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">VirtAddr</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">PhysAddr</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">FileSize</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">MemSize</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Flag&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> ( nEntries<span style="color:#f92672">--</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_type <span style="color:#f92672">!=</span> PT_NULL )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">switch</span> ( ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_type )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_LOAD:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;LOAD</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_DYNAMIC:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;DYNAMIC</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_INTERP:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;INTERP</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_NOTE:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;NOTE</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_SHLIB:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;SHLIB</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_PHDR:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;PHDR</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_GNU_STACK:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;GNU_STACK&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_LOPROC:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;LOPROC</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> PT_HIPROC:
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;HIPROC</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Unknown</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%d</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">%d</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_offset,
</span></span><span style="display:flex;"><span>                ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_vaddr,
</span></span><span style="display:flex;"><span>                ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_paddr,
</span></span><span style="display:flex;"><span>                ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_filesz,
</span></span><span style="display:flex;"><span>                ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_memsz
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_flags <span style="color:#f92672">&amp;</span> PF_X )
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;EXECUTABLE &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_flags <span style="color:#f92672">&amp;</span> PF_W )
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;WRITABLE &#34;</span>);
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( ((Elf64_Phdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>p_flags <span style="color:#f92672">&amp;</span> PF_R )
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;READABLE &#34;</span>);
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// New Line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Next entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        elfPtr <span style="color:#f92672">+=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_phentsize;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//**************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">PRINT_LINE</span>(<span style="color:#e6db74">&#34;Section Header&#34;</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Move to section header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shoff;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Section name string header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfSectionPtr <span style="color:#f92672">=</span> elfPtr <span style="color:#f92672">+</span> ( ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shstrndx <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(Elf64_Shdr) );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Jump on the names table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfSectionPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfSectionPtr)<span style="color:#f92672">-&gt;</span>sh_offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Number of entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    nEntries <span style="color:#f92672">=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shnum;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Offset</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Addr</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Size</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Type</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Name</span><span style="color:#ae81ff">\t\t\t</span><span style="color:#e6db74">Flags&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> ( nEntries<span style="color:#f92672">--</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_type <span style="color:#f92672">!=</span> SHT_NOBITS <span style="color:#f92672">&amp;&amp;</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_size )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;0x%LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%d</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">0x%08LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%s&#34;</span>,
</span></span><span style="display:flex;"><span>                ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_offset,
</span></span><span style="display:flex;"><span>                ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_addr,
</span></span><span style="display:flex;"><span>                ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_size,
</span></span><span style="display:flex;"><span>                ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_type,
</span></span><span style="display:flex;"><span>                (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) elfSectionPtr <span style="color:#f92672">+</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_name 
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Alignment
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            wPadding <span style="color:#f92672">=</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">strlen</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) elfSectionPtr <span style="color:#f92672">+</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_name);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> ( wPadding<span style="color:#f92672">--</span> ) <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Handle flags
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> ( ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_flags <span style="color:#f92672">&amp;</span> SHF_WRITE )
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;WRITABLE &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_flags <span style="color:#f92672">&amp;</span> SHF_ALLOC )
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ALLOCATABLE &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_flags <span style="color:#f92672">&amp;</span> SHF_EXECINSTR )
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;EXECUTABLE &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// New Line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Next section
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        elfPtr <span style="color:#f92672">+=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shentsize;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ParseSymbols</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pBaseAddress)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Elf64_Addr elfPtr;
</span></span><span style="display:flex;"><span>    Elf64_Addr elfSectionHdrPtr;
</span></span><span style="display:flex;"><span>    Elf64_Addr elfSymPtr;
</span></span><span style="display:flex;"><span>    Elf64_Addr elfStrSectionPtr;
</span></span><span style="display:flex;"><span>    Elf64_Half nEntries;
</span></span><span style="display:flex;"><span>    Elf64_Word wSymbols;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PRINT_LINE</span>(<span style="color:#e6db74">&#34;Symbols&#34;</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Pointing now to the section header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfSectionHdrPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shoff;
</span></span><span style="display:flex;"><span>    elfPtr <span style="color:#f92672">=</span> elfSectionHdrPtr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Number of section entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    nEntries <span style="color:#f92672">=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shnum;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Value</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Type</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Bind</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Size</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Name&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Iterate over all section entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> ( nEntries<span style="color:#f92672">--</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Find symbols
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>            ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_type <span style="color:#f92672">==</span> SHT_SYMTAB <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>            ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_type <span style="color:#f92672">==</span> SHT_DYNSYM
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Jump on the symbols section
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            elfSymPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Find string section header table 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            elfStrSectionPtr <span style="color:#f92672">=</span> elfSectionHdrPtr <span style="color:#f92672">+</span> ( <span style="color:#66d9ef">sizeof</span>(Elf64_Shdr) <span style="color:#f92672">*</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_link );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Jump on the string table ( .strtab )
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            elfStrSectionPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfStrSectionPtr)<span style="color:#f92672">-&gt;</span>sh_offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Calculate the number of symbols
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            wSymbols <span style="color:#f92672">=</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_size <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(Elf64_Sym);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Iterate over all symbol entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> ( wSymbols<span style="color:#f92672">--</span> )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> ( ((Elf64_Sym <span style="color:#f92672">*</span>) elfSymPtr)<span style="color:#f92672">-&gt;</span>st_size )
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;0x%08LX</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%02X</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%02X</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%d</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                        ((Elf64_Sym <span style="color:#f92672">*</span>) elfSymPtr)<span style="color:#f92672">-&gt;</span>st_value,
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">ELF64_ST_TYPE</span>( ((Elf64_Sym <span style="color:#f92672">*</span>) elfSymPtr)<span style="color:#f92672">-&gt;</span>st_info ),
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">ELF64_ST_BIND</span>( ((Elf64_Sym <span style="color:#f92672">*</span>) elfSymPtr)<span style="color:#f92672">-&gt;</span>st_info ),
</span></span><span style="display:flex;"><span>                        ((Elf64_Sym <span style="color:#f92672">*</span>) elfSymPtr)<span style="color:#f92672">-&gt;</span>st_size,
</span></span><span style="display:flex;"><span>                        (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) elfStrSectionPtr <span style="color:#f92672">+</span> ((Elf64_Sym <span style="color:#f92672">*</span>) elfSymPtr)<span style="color:#f92672">-&gt;</span>st_name
</span></span><span style="display:flex;"><span>                    );
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Next symbol entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                elfSymPtr <span style="color:#f92672">+=</span> <span style="color:#66d9ef">sizeof</span>(Elf64_Sym);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Next section entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        elfPtr <span style="color:#f92672">+=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shentsize;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ParseRelocations</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pBaseAddress)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Elf64_Addr elfPtr;
</span></span><span style="display:flex;"><span>    Elf64_Addr elfRelocPtr;
</span></span><span style="display:flex;"><span>    Elf64_Half nEntries;
</span></span><span style="display:flex;"><span>    Elf64_Word wRelocEntries;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PRINT_LINE</span>(<span style="color:#e6db74">&#34;Relocations&#34;</span>, <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Pointing now to the section header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    elfPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shoff;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Number of sections
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    nEntries <span style="color:#f92672">=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shnum;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Offset</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Addend</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Type</span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">Symtab index&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Iterate over all sections
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> ( nEntries<span style="color:#f92672">--</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Find relocation section header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ( ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_type <span style="color:#f92672">==</span> SHT_RELA )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Find relocations entries of current section
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            elfRelocPtr <span style="color:#f92672">=</span> (Elf64_Addr) pBaseAddress <span style="color:#f92672">+</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Number of relocation entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            wRelocEntries <span style="color:#f92672">=</span> ((Elf64_Shdr <span style="color:#f92672">*</span>) elfPtr)<span style="color:#f92672">-&gt;</span>sh_size <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(Elf64_Rela);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Iterate over all relocation entries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> ( wRelocEntries<span style="color:#f92672">--</span> )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;0x%08X</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08X</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08X</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                    ((Elf64_Rela <span style="color:#f92672">*</span>) elfRelocPtr)<span style="color:#f92672">-&gt;</span>r_offset,
</span></span><span style="display:flex;"><span>                    ((Elf64_Rela <span style="color:#f92672">*</span>) elfRelocPtr)<span style="color:#f92672">-&gt;</span>r_addend,
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">ELF64_R_TYPE</span>( ((Elf64_Rela <span style="color:#f92672">*</span>) elfRelocPtr)<span style="color:#f92672">-&gt;</span>r_info ),
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">ELF64_R_SYM</span>( ((Elf64_Rela <span style="color:#f92672">*</span>) elfRelocPtr)<span style="color:#f92672">-&gt;</span>r_info )
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Next reloc entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                elfRelocPtr <span style="color:#f92672">+=</span> <span style="color:#66d9ef">sizeof</span>(Elf64_Rela);
</span></span><span style="display:flex;"><span>            } 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Next section entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        elfPtr <span style="color:#f92672">+=</span> ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_shentsize;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">ParseELF</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pBaseAddress)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check if a valid ELF file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(
</span></span><span style="display:flex;"><span>        ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_ident[EI_MAG0] <span style="color:#f92672">==</span> ELFMAG0 <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_ident[EI_MAG1] <span style="color:#f92672">==</span> ELFMAG1 <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_ident[EI_MAG2] <span style="color:#f92672">==</span> ELFMAG2 <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_ident[EI_MAG3] <span style="color:#f92672">==</span> ELFMAG3 
</span></span><span style="display:flex;"><span>    ))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check if the given ELF is x32 bit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ( ((Elf64_Ehdr <span style="color:#f92672">*</span>) pBaseAddress)<span style="color:#f92672">-&gt;</span>e_ident[EI_CLASS] <span style="color:#f92672">==</span> ELFCLASS32 )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ParseHeaders</span>(pBaseAddress);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ParseSymbols</span>(pBaseAddress);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ParseRelocations</span>(pBaseAddress);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ReadELFFile</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cpFileName)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    FILE <span style="color:#f92672">*</span>pFile;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pBuffer;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> lSize;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Get a file handle
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ( pFile <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(cpFileName, <span style="color:#e6db74">&#34;rb&#34;</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Tell the handle about the ending of the file to obtain its size 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">fseek</span>(pFile, <span style="color:#ae81ff">0L</span>, SEEK_END);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Get the file size
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        lSize <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftell</span>(pFile);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Restore back the handle
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">fseek</span>(pFile, <span style="color:#ae81ff">0L</span>, SEEK_SET);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Allocate some memory for the buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>(pBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(lSize)) ) <span style="color:#75715e">// OOM CASE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">goto</span> LEAVE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Read the file content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">fread</span>(pBuffer, lSize, <span style="color:#ae81ff">1L</span>, pFile);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LEAVE:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( pFile ) <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pBuffer;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pBuffer;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> nRet <span style="color:#f92672">=</span> EXIT_FAILURE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( argc <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Usage:</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">./ELFParser &lt;/path/to/elffile&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">ReadELFFile</span>(argv[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span> pBuffer )
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Failed to read %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> LEAVE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span> <span style="color:#a6e22e">ParseELF</span>(pBuffer) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Invalid ELF file, or maybe 32-bit application&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LEAVE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	nRet <span style="color:#f92672">=</span> EXIT_SUCCESS;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LEAVE:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> ( pBuffer ) <span style="color:#a6e22e">free</span>(pBuffer);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> nRet;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="test">Test</h2>
<p>Let&rsquo;s test the parser on the following application:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{ 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Hello World!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Compiled via <code>gcc test.c -o test</code>. Let&rsquo;s run the parser.</p>
<pre tabindex="0"><code>
┌──(user㉿host)-[~/path/to]
└─$ ./ELFParser ~/test

------ELF HEADER------------------------------------------------------------------------------------------
Image magic number          =&gt; 464C457F (ELF)
Arch                        =&gt; x64
ELF type                    =&gt; DYN (Position-Independent Executable file)
Machine                     =&gt; AMD x86-64
Entry point                 =&gt; 0x1050
ELF header size             =&gt; 64
Program header offset       =&gt; 0x40
Program header Entry size   =&gt; 56
Numbre of entries           =&gt; 13
Section header offset       =&gt; 0x3738
Section header size         =&gt; 64
Numbre of entries           =&gt; 31
Section name table offset   =&gt; 0x1E

------Program Header--------------------------------------------------------------------------------------
Type		Offset		VirtAddr	PhysAddr	FileSize	MemSize	Flag
PHDR		0x00000040	0x00000040	0x00000040	728		728	READABLE 
INTERP		0x00000318	0x00000318	0x00000318	28		28	READABLE 
LOAD		0x00000000	0x00000000	0x00000000	1528		1528	READABLE 
LOAD		0x00001000	0x00001000	0x00001000	445		445	EXECUTABLE READABLE 
LOAD		0x00002000	0x00002000	0x00002000	344		344	READABLE 
LOAD		0x00002DE8	0x00003DE8	0x00003DE8	584		592	WRITABLE READABLE 
DYNAMIC		0x00002DF8	0x00003DF8	0x00003DF8	480		480	WRITABLE READABLE 
NOTE		0x00000338	0x00000338	0x00000338	32		32	READABLE 
NOTE		0x00000358	0x00000358	0x00000358	68		68	READABLE 
Unknown		0x00000338	0x00000338	0x00000338	32		32	READABLE 
Unknown		0x00002014	0x00002014	0x00002014	60		60	READABLE 
GNU_STACK	0x00000000	0x00000000	0x00000000	0		0	WRITABLE READABLE 
Unknown		0x00002DE8	0x00003DE8	0x00003DE8	536		536	READABLE 

------Section Header--------------------------------------------------------------------------------------
Offset	Addr		Size		Type		Name			Flags
0x318	0x00000318	28		0x00000001	.interp                 ALLOCATABLE 
0x338	0x00000338	32		0x00000007	.note.gnu.property      ALLOCATABLE 
0x358	0x00000358	36		0x00000007	.note.gnu.build-id      ALLOCATABLE 
0x37C	0x0000037C	32		0x00000007	.note.ABI-tag           ALLOCATABLE 
0x3A0	0x000003A0	36		0x6FFFFFF6	.gnu.hash               ALLOCATABLE 
0x3C8	0x000003C8	168		0x0000000B	.dynsym                 ALLOCATABLE 
0x470	0x00000470	130		0x00000003	.dynstr                 ALLOCATABLE 
0x4F2	0x000004F2	14		0x6FFFFFFF	.gnu.version            ALLOCATABLE 
0x500	0x00000500	32		0x6FFFFFFE	.gnu.version_r          ALLOCATABLE 
0x520	0x00000520	192		0x00000004	.rela.dyn               ALLOCATABLE 
0x5E0	0x000005E0	24		0x00000004	.rela.plt               ALLOCATABLE 
0x1000	0x00001000	23		0x00000001	.init                   ALLOCATABLE EXECUTABLE 
0x1020	0x00001020	32		0x00000001	.plt                    ALLOCATABLE EXECUTABLE 
0x1040	0x00001040	8		0x00000001	.plt.got                ALLOCATABLE EXECUTABLE 
0x1050	0x00001050	353		0x00000001	.text                   ALLOCATABLE EXECUTABLE 
0x11B4	0x000011B4	9		0x00000001	.fini                   ALLOCATABLE EXECUTABLE 
0x2000	0x00002000	17		0x00000001	.rodata                 ALLOCATABLE 
0x2014	0x00002014	60		0x00000001	.eh_frame_hdr           ALLOCATABLE 
0x2050	0x00002050	264		0x00000001	.eh_frame               ALLOCATABLE 
0x2DE8	0x00003DE8	8		0x0000000E	.init_array             WRITABLE ALLOCATABLE 
0x2DF0	0x00003DF0	8		0x0000000F	.fini_array             WRITABLE ALLOCATABLE 
0x2DF8	0x00003DF8	480		0x00000006	.dynamic                WRITABLE ALLOCATABLE 
0x2FD8	0x00003FD8	40		0x00000001	.got                    WRITABLE ALLOCATABLE 
0x3000	0x00004000	32		0x00000001	.got.plt                WRITABLE ALLOCATABLE 
0x3020	0x00004020	16		0x00000001	.data                   WRITABLE ALLOCATABLE 
0x3030	0x00000000	31		0x00000001	.comment                
0x3050	0x00000000	960		0x00000002	.symtab                 
0x3410	0x00000000	526		0x00000003	.strtab                 
0x361E	0x00000000	282		0x00000003	.shstrtab               

------Symbols---------------------------------------------------------------------------------------------
Value		Type	Bind	Size	Name
0x0000037C	0x01	0x00	32	__abi_tag
0x00004030	0x01	0x00	1	completed.0
0x000011B0	0x02	0x01	1	__libc_csu_fini
0x00002000	0x01	0x01	4	_IO_stdin_used
0x00001150	0x02	0x01	93	__libc_csu_init
0x00001050	0x02	0x01	43	_start
0x00001139	0x02	0x01	22	main

------Relocations-----------------------------------------------------------------------------------------
Offset		Addend		Type		Symtab index
0x00003DE8	0x00001130	0x00000008	0
0x00003DF0	0x000010F0	0x00000008	0
0x00004028	0x00004028	0x00000008	0
0x00003FD8	0x00000000	0x00000006	1
0x00003FE0	0x00000000	0x00000006	3
0x00003FE8	0x00000000	0x00000006	4
0x00003FF0	0x00000000	0x00000006	5
0x00003FF8	0x00000000	0x00000006	6
0x00004018	0x00000000	0x00000007	2
</code></pre><h2 id="conclusion">Conclusion</h2>
<p>I would say that the topic is not easy and requires some effort, focus, and practice to understand it well, so I encourage you to try implementing your own parser yourself. Thank you for reading.</p>
</div>
    </article>
  </main>

      </div>
      <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      <br />
      
        
        <a href="https://github.com/0xNinjaCyclone">GitHub</a>
      
         | 
        <a href="https://twitter.com/0xNinjaCyclone">Twitter</a>
      
         | 
        <a href="https://www.facebook.com/abdallah.elsharif07">Facebook</a>
      
    </p>
  
</footer>

    </div>
  </body>
</html>
